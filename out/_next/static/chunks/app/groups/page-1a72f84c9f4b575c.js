(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[586],{2874:function(e,t,s){Promise.resolve().then(s.bind(s,2484))},2484:function(e,t,s){"use strict";let r;s.r(t),s.d(t,{default:function(){return U}});var i=s(7437),n=s(683),a=s(4316),u=s(3191),l=s(4939),o=s(9948),c=s(2459),h=s(9010),d=s(6922),p=s(6298),f=s(3743),m=class extends h.l{constructor(e,t){super(),this.options=t,this.#e=e,this.#t=null,this.#s=(0,d.O)(),this.bindMethods(),this.setOptions(t)}#e;#r=void 0;#i=void 0;#n=void 0;#a;#u;#s;#t;#l;#o;#c;#h;#d;#p;#f=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){1===this.listeners.size&&(this.#r.addObserver(this),y(this.#r,this.options)?this.#m():this.updateResult(),this.#y())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return b(this.#r,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return b(this.#r,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#b(),this.#v(),this.#r.removeObserver(this)}setOptions(e){let t=this.options,s=this.#r;if(this.options=this.#e.defaultQueryOptions(e),void 0!==this.options.enabled&&"boolean"!=typeof this.options.enabled&&"function"!=typeof this.options.enabled&&"boolean"!=typeof(0,p.Nc)(this.options.enabled,this.#r))throw Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#g(),this.#r.setOptions(this.options),t._defaulted&&!(0,p.VS)(this.options,t)&&this.#e.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#r,observer:this});let r=this.hasListeners();r&&v(this.#r,s,this.options,t)&&this.#m(),this.updateResult(),r&&(this.#r!==s||(0,p.Nc)(this.options.enabled,this.#r)!==(0,p.Nc)(t.enabled,this.#r)||(0,p.KC)(this.options.staleTime,this.#r)!==(0,p.KC)(t.staleTime,this.#r))&&this.#x();let i=this.#R();r&&(this.#r!==s||(0,p.Nc)(this.options.enabled,this.#r)!==(0,p.Nc)(t.enabled,this.#r)||i!==this.#p)&&this.#C(i)}getOptimisticResult(e){let t=this.#e.getQueryCache().build(this.#e,e),s=this.createResult(t,e);return(0,p.VS)(this.getCurrentResult(),s)||(this.#n=s,this.#u=this.options,this.#a=this.#r.state),s}getCurrentResult(){return this.#n}trackResult(e,t){return new Proxy(e,{get:(e,s)=>(this.trackProp(s),t?.(s),"promise"!==s||(this.trackProp("data"),this.options.experimental_prefetchInRender||"pending"!==this.#s.status||this.#s.reject(Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(e,s))})}trackProp(e){this.#f.add(e)}getCurrentQuery(){return this.#r}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){let t=this.#e.defaultQueryOptions(e),s=this.#e.getQueryCache().build(this.#e,t);return s.fetch().then(()=>this.createResult(s,t))}fetch(e){return this.#m({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#n))}#m(e){this.#g();let t=this.#r.fetch(this.options,e);return e?.throwOnError||(t=t.catch(p.ZT)),t}#x(){this.#b();let e=(0,p.KC)(this.options.staleTime,this.#r);if(p.sk||this.#n.isStale||!(0,p.PN)(e))return;let t=(0,p.Kp)(this.#n.dataUpdatedAt,e);this.#h=f.mr.setTimeout(()=>{this.#n.isStale||this.updateResult()},t+1)}#R(){return("function"==typeof this.options.refetchInterval?this.options.refetchInterval(this.#r):this.options.refetchInterval)??!1}#C(e){this.#v(),this.#p=e,!p.sk&&!1!==(0,p.Nc)(this.options.enabled,this.#r)&&(0,p.PN)(this.#p)&&0!==this.#p&&(this.#d=f.mr.setInterval(()=>{(this.options.refetchIntervalInBackground||l.j.isFocused())&&this.#m()},this.#p))}#y(){this.#x(),this.#C(this.#R())}#b(){this.#h&&(f.mr.clearTimeout(this.#h),this.#h=void 0)}#v(){this.#d&&(f.mr.clearInterval(this.#d),this.#d=void 0)}createResult(e,t){let s;let r=this.#r,i=this.options,n=this.#n,a=this.#a,u=this.#u,l=e!==r?e.state:this.#i,{state:o}=e,h={...o},f=!1;if(t._optimisticResults){let s=this.hasListeners(),n=!s&&y(e,t),a=s&&v(e,r,t,i);(n||a)&&(h={...h,...(0,c.z)(o.data,e.options)}),"isRestoring"===t._optimisticResults&&(h.fetchStatus="idle")}let{error:m,errorUpdatedAt:b,status:x}=h;s=h.data;let R=!1;if(void 0!==t.placeholderData&&void 0===s&&"pending"===x){let e;n?.isPlaceholderData&&t.placeholderData===u?.placeholderData?(e=n.data,R=!0):e="function"==typeof t.placeholderData?t.placeholderData(this.#c?.state.data,this.#c):t.placeholderData,void 0!==e&&(x="success",s=(0,p.oE)(n?.data,e,t),f=!0)}if(t.select&&void 0!==s&&!R){if(n&&s===a?.data&&t.select===this.#l)s=this.#o;else try{this.#l=t.select,s=t.select(s),s=(0,p.oE)(n?.data,s,t),this.#o=s,this.#t=null}catch(e){this.#t=e}}this.#t&&(m=this.#t,s=this.#o,b=Date.now(),x="error");let C="fetching"===h.fetchStatus,O="pending"===x,N="error"===x,I=O&&C,S=void 0!==s,Q={status:x,fetchStatus:h.fetchStatus,isPending:O,isSuccess:"success"===x,isError:N,isInitialLoading:I,isLoading:I,data:s,dataUpdatedAt:h.dataUpdatedAt,error:m,errorUpdatedAt:b,failureCount:h.fetchFailureCount,failureReason:h.fetchFailureReason,errorUpdateCount:h.errorUpdateCount,isFetched:h.dataUpdateCount>0||h.errorUpdateCount>0,isFetchedAfterMount:h.dataUpdateCount>l.dataUpdateCount||h.errorUpdateCount>l.errorUpdateCount,isFetching:C,isRefetching:C&&!O,isLoadingError:N&&!S,isPaused:"paused"===h.fetchStatus,isPlaceholderData:f,isRefetchError:N&&S,isStale:g(e,t),refetch:this.refetch,promise:this.#s,isEnabled:!1!==(0,p.Nc)(t.enabled,e)};if(this.options.experimental_prefetchInRender){let t=e=>{"error"===Q.status?e.reject(Q.error):void 0!==Q.data&&e.resolve(Q.data)},s=()=>{t(this.#s=Q.promise=(0,d.O)())},i=this.#s;switch(i.status){case"pending":e.queryHash===r.queryHash&&t(i);break;case"fulfilled":("error"===Q.status||Q.data!==i.value)&&s();break;case"rejected":("error"!==Q.status||Q.error!==i.reason)&&s()}}return Q}updateResult(){let e=this.#n,t=this.createResult(this.#r,this.options);this.#a=this.#r.state,this.#u=this.options,void 0!==this.#a.data&&(this.#c=this.#r),(0,p.VS)(t,e)||(this.#n=t,this.#O({listeners:(()=>{if(!e)return!0;let{notifyOnChangeProps:t}=this.options,s="function"==typeof t?t():t;if("all"===s||!s&&!this.#f.size)return!0;let r=new Set(s??this.#f);return this.options.throwOnError&&r.add("error"),Object.keys(this.#n).some(t=>this.#n[t]!==e[t]&&r.has(t))})()}))}#g(){let e=this.#e.getQueryCache().build(this.#e,this.options);if(e===this.#r)return;let t=this.#r;this.#r=e,this.#i=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#y()}#O(e){o.Vr.batch(()=>{e.listeners&&this.listeners.forEach(e=>{e(this.#n)}),this.#e.getQueryCache().notify({query:this.#r,type:"observerResultsUpdated"})})}};function y(e,t){return!1!==(0,p.Nc)(t.enabled,e)&&void 0===e.state.data&&!("error"===e.state.status&&!1===t.retryOnMount)||void 0!==e.state.data&&b(e,t,t.refetchOnMount)}function b(e,t,s){if(!1!==(0,p.Nc)(t.enabled,e)&&"static"!==(0,p.KC)(t.staleTime,e)){let r="function"==typeof s?s(e):s;return"always"===r||!1!==r&&g(e,t)}return!1}function v(e,t,s,r){return(e!==t||!1===(0,p.Nc)(r.enabled,e))&&(!s.suspense||"error"!==e.state.status)&&g(e,s)}function g(e,t){return!1!==(0,p.Nc)(t.enabled,e)&&e.isStaleByTime((0,p.KC)(t.staleTime,e))}var x=s(2265),R=x.createContext((r=!1,{clearReset:()=>{r=!1},reset:()=>{r=!0},isReset:()=>r})),C=()=>x.useContext(R),O=(e,t)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&!t.isReset()&&(e.retryOnMount=!1)},N=e=>{x.useEffect(()=>{e.clearReset()},[e])},I=e=>{let{result:t,errorResetBoundary:s,throwOnError:r,query:i,suspense:n}=e;return t.isError&&!s.isReset()&&!t.isFetching&&i&&(n&&void 0===t.data||(0,p.L3)(r,[t.error,i]))},S=x.createContext(!1),Q=()=>x.useContext(S);S.Provider;var w=e=>{if(e.suspense){let t=e=>"static"===e?e:Math.max(e??1e3,1e3),s=e.staleTime;e.staleTime="function"==typeof s?(...e)=>t(s(...e)):t(s),"number"==typeof e.gcTime&&(e.gcTime=Math.max(e.gcTime,1e3))}},_=(e,t)=>e.isLoading&&e.isFetching&&!t,E=(e,t)=>e?.suspense&&t.isPending,j=(e,t,s)=>t.fetchOptimistic(e).catch(()=>{s.clearReset()}),T=s(2812),M=class extends h.l{#e;#n=void 0;#N;#I;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#S()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,p.VS)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#N,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,p.Ym)(t.mutationKey)!==(0,p.Ym)(this.options.mutationKey)?this.reset():this.#N?.state.status==="pending"&&this.#N.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#N?.removeObserver(this)}onMutationUpdate(e){this.#S(),this.#O(e)}getCurrentResult(){return this.#n}reset(){this.#N?.removeObserver(this),this.#N=void 0,this.#S(),this.#O()}mutate(e,t){return this.#I=t,this.#N?.removeObserver(this),this.#N=this.#e.getMutationCache().build(this.#e,this.options),this.#N.addObserver(this),this.#N.execute(e)}#S(){let e=this.#N?.state??(0,T.R)();this.#n={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#O(e){o.Vr.batch(()=>{if(this.#I&&this.hasListeners()){let t=this.#n.variables,s=this.#n.context,r={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};e?.type==="success"?(this.#I.onSuccess?.(e.data,t,s,r),this.#I.onSettled?.(e.data,null,t,s,r)):e?.type==="error"&&(this.#I.onError?.(e.error,t,s,r),this.#I.onSettled?.(void 0,e.error,t,s,r))}this.listeners.forEach(e=>{e(this.#n)})})}},k=s(7138),P=s(6463);function F(){var e,t,s,r;let{user:l,loading:c}=(0,n.aC)(),h=(0,u.NL)(),d=(0,P.useSearchParams)(),f=(null==d?void 0:d.get("new"))==="1",[y,b]=(0,x.useState)(f),[v,g]=(0,x.useState)(""),R=(0,x.useMemo)(()=>(0,a.N)(),[]),S=function(e,t,s){var r,i,n,a,l;let c=Q(),h=C(),d=(0,u.NL)(s),f=d.defaultQueryOptions(e);null===(i=d.getDefaultOptions().queries)||void 0===i||null===(r=i._experimental_beforeQuery)||void 0===r||r.call(i,f),f._optimisticResults=c?"isRestoring":"optimistic",w(f),O(f,h),N(h);let m=!d.getQueryCache().get(f.queryHash),[y]=x.useState(()=>new t(d,f)),b=y.getOptimisticResult(f),v=!c&&!1!==e.subscribed;if(x.useSyncExternalStore(x.useCallback(e=>{let t=v?y.subscribe(o.Vr.batchCalls(e)):p.ZT;return y.updateResult(),t},[y,v]),()=>y.getCurrentResult(),()=>y.getCurrentResult()),x.useEffect(()=>{y.setOptions(f)},[f,y]),E(f,b))throw j(f,y,h);if(I({result:b,errorResetBoundary:h,throwOnError:f.throwOnError,query:d.getQueryCache().get(f.queryHash),suspense:f.suspense}))throw b.error;if(null===(a=d.getDefaultOptions().queries)||void 0===a||null===(n=a._experimental_afterQuery)||void 0===n||n.call(a,f,b),f.experimental_prefetchInRender&&!p.sk&&_(b,c)){let e=m?j(f,y,h):null===(l=d.getQueryCache().get(f.queryHash))||void 0===l?void 0:l.promise;null==e||e.catch(p.ZT).finally(()=>{y.updateResult()})}return f.notifyOnChangeProps?b:y.trackResult(b)}({queryKey:["groups",null==l?void 0:l.id],enabled:!!(null==l?void 0:l.id),queryFn:async()=>{if(!(null==l?void 0:l.id))return[];let{data:e,error:t}=await R.from("group_members").select("group:groups(id, name, created_at)").eq("user_id",l.id).eq("is_active",!0).order("group(name)");if(t)throw t;return(null!=e?e:[]).map(e=>e.group).filter(e=>!!e)}},m,void 0),T=function(e,t){let s=(0,u.NL)(void 0),[r]=x.useState(()=>new M(s,e));x.useEffect(()=>{r.setOptions(e)},[r,e]);let i=x.useSyncExternalStore(x.useCallback(e=>r.subscribe(o.Vr.batchCalls(e)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),n=x.useCallback((e,t)=>{r.mutate(e,t).catch(p.ZT)},[r]);if(i.error&&(0,p.L3)(r.options.throwOnError,[i.error]))throw i.error;return{...i,mutate:n,mutateAsync:i.mutate}}({mutationFn:async e=>{if(!(null==l?void 0:l.id))throw Error("Debes iniciar sesi\xf3n");if(!e.trim())throw Error("Introduce un nombre de grupo");let t={name:e.trim()},{data:s,error:r}=await R.from("groups").insert(t).select("id, name, created_at").single();if(r)throw r;let i={group_id:s.id,user_id:l.id,is_active:!0},{error:n}=await R.from("group_members").insert(i);if(n)throw n;return s},onSuccess:async()=>{await h.invalidateQueries({queryKey:["groups",null==l?void 0:l.id]})}});return c?(0,i.jsx)("main",{className:"p-6 text-sm text-gray-500",children:"Cargando grupos..."}):l?(0,i.jsx)(n.ZP,{children:(0,i.jsxs)("main",{className:"p-6 space-y-6",children:[(0,i.jsxs)("header",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h1",{className:"text-2xl font-semibold",children:"Tus grupos"}),(0,i.jsx)("p",{className:"text-gray-600 text-sm",children:"Crea un grupo nuevo o entra en uno existente."})]}),(0,i.jsx)("button",{className:"bg-black text-white px-4 py-2 rounded",onClick:()=>b(!0),children:"Nuevo grupo"})]}),y&&(0,i.jsxs)("form",{className:"border p-4 rounded space-y-3",onSubmit:function(e){e.preventDefault(),T.mutate(v,{onSuccess:e=>{g(""),b(!1),e&&(window.location.href="/groups/".concat(e.id))}})},children:[(0,i.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:["Nombre del grupo",(0,i.jsx)("input",{className:"border px-3 py-2 rounded",placeholder:"Viaje a la sierra",required:!0,value:v,onChange:e=>g(e.target.value)})]}),(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)("button",{className:"bg-black text-white px-4 py-2 rounded",disabled:T.isPending,type:"submit",children:"Crear y entrar"}),(0,i.jsx)("button",{className:"text-sm text-gray-600",onClick:()=>b(!1),type:"button",children:"Cancelar"})]}),T.error&&(0,i.jsx)("p",{className:"text-sm text-red-600",children:null!==(s=T.error.message)&&void 0!==s?s:"No se pudo crear el grupo"})]}),(0,i.jsxs)("section",{className:"space-y-3",children:[(0,i.jsx)("h2",{className:"text-lg font-semibold",children:"Grupos existentes"}),(0,i.jsx)("ul",{className:"space-y-2",children:null===(e=S.data)||void 0===e?void 0:e.map(e=>(0,i.jsxs)("li",{className:"border rounded p-3 flex items-center justify-between",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("p",{className:"font-medium",children:e.name}),(0,i.jsxs)("p",{className:"text-xs text-gray-500",children:["Creado ",new Date(e.created_at).toLocaleDateString()]})]}),(0,i.jsx)(k.default,{className:"text-sm text-blue-600",href:"/groups/".concat(e.id),children:"Abrir"})]},e.id))}),S.isLoading&&(0,i.jsx)("p",{className:"text-sm text-gray-500",children:"Cargando..."}),S.error&&(0,i.jsx)("p",{className:"text-sm text-red-600",children:null!==(r=S.error.message)&&void 0!==r?r:"No se pudieron obtener los grupos"}),(null===(t=S.data)||void 0===t?void 0:t.length)===0&&!S.isLoading&&(0,i.jsx)("p",{className:"text-sm text-gray-500",children:"Todav\xeda no perteneces a ning\xfan grupo."})]})]})}):null}function U(){return(0,i.jsx)(x.Suspense,{fallback:(0,i.jsx)("div",{children:"Cargando..."}),children:(0,i.jsx)(F,{})})}},683:function(e,t,s){"use strict";s.d(t,{Ho:function(){return o},aC:function(){return c}});var r=s(7437),i=s(4316),n=s(6463),a=s(2265);let u=(0,a.createContext)(void 0);async function l(e){var t;if(!e)return null;let s=(0,i.N)(),{data:r,error:n}=await s.from("profiles").select("id, email, display_name").eq("id",e.id).maybeSingle();if(n)return console.error("Error al comprobar el perfil",n),null!=r?r:null;if(r)return r;let a={id:e.id,email:e.email,display_name:null===(t=e.user_metadata)||void 0===t?void 0:t.display_name},{data:u,error:l}=await (0,i.N)().from("profiles").upsert(a).select("id, email, display_name").single();return l?(console.error("Error al crear el perfil",l),null!=r?r:a):null!=u?u:a}function o(e){let{children:t}=e,s=(0,n.useRouter)(),o=(0,n.usePathname)(),[c,h]=(0,a.useState)(null),[d,p]=(0,a.useState)(null),[f,m]=(0,a.useState)(!0),y=(0,i.N)(),b=(0,a.useCallback)(async()=>{var e,t;m(!0);let{data:s,error:r}=await y.auth.getSession();if(r){console.error("Error al recuperar la sesi\xf3n",r),h(null),p(null),m(!1);return}let i=null!==(e=s.session)&&void 0!==e?e:null;h(i);let n=await l(null!==(t=null==i?void 0:i.user)&&void 0!==t?t:null);p(null!=n?n:null),m(!1)},[y]);(0,a.useEffect)(()=>{let e=!0;b().finally(()=>{e&&m(!1)});let{data:t}=y.auth.onAuthStateChange(async(e,t)=>{var r;h(t);let i=await l(null!==(r=null==t?void 0:t.user)&&void 0!==r?r:null);p(null!=i?i:null),t||"/login"===o?t&&"/login"===o&&s.replace("/"):s.replace("/login")});return()=>{e=!1,t.subscription.unsubscribe()}},[o,b,s,y]);let v=(0,a.useMemo)(()=>{var e;return{session:c,user:null!==(e=null==c?void 0:c.user)&&void 0!==e?e:null,profile:d,loading:f,refresh:b}},[c,d,f,b]);return(0,r.jsx)(u.Provider,{value:v,children:t})}function c(){let e=(0,a.useContext)(u);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}t.ZP=function(e){let{children:t}=e,{loading:s,user:i}=c();return s?(0,r.jsx)("div",{className:"p-6 text-sm text-gray-500",children:"Cargando sesi\xf3n..."}):i?(0,r.jsx)(r.Fragment,{children:t}):null}},4316:function(e,t,s){"use strict";s.d(t,{N:function(){return n}});var r=s(46);let i=globalThis;function n(){let e="https://hlhcpdymkqhqpsaafthm.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsaGNwZHlta3FocXBzYWFmdGhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NDA0MTgsImV4cCI6MjA3ODExNjQxOH0.H_6vnlgCcT_gxmKK9MSOpI9w-p49VnsTV5WZtNcAmys";if(!e||!t)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY environment variables");return i.__supabaseClient||(i.__supabaseClient=(0,r.eI)(e,t)),i.__supabaseClient}}},function(e){e.O(0,[46,291,832,971,23,744],function(){return e(e.s=2874)}),_N_E=e.O()}]);