(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[586],{6325:function(e,t,r){Promise.resolve().then(r.bind(r,2484))},2484:function(e,t,r){"use strict";let s;r.r(t),r.d(t,{default:function(){return L}});var i=r(7437),n=r(683),a=r(4316),u=r(3191),o=r(4939),l=r(9948),c=r(2459),h=r(9010),d=r(6922),p=r(6298),f=r(3743),m=class extends h.l{constructor(e,t){super(),this.options=t,this.#e=e,this.#t=null,this.#r=(0,d.O)(),this.bindMethods(),this.setOptions(t)}#e;#s=void 0;#i=void 0;#n=void 0;#a;#u;#r;#t;#o;#l;#c;#h;#d;#p;#f=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){1===this.listeners.size&&(this.#s.addObserver(this),y(this.#s,this.options)?this.#m():this.updateResult(),this.#y())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return v(this.#s,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return v(this.#s,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#v(),this.#b(),this.#s.removeObserver(this)}setOptions(e){let t=this.options,r=this.#s;if(this.options=this.#e.defaultQueryOptions(e),void 0!==this.options.enabled&&"boolean"!=typeof this.options.enabled&&"function"!=typeof this.options.enabled&&"boolean"!=typeof(0,p.Nc)(this.options.enabled,this.#s))throw Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#g(),this.#s.setOptions(this.options),t._defaulted&&!(0,p.VS)(this.options,t)&&this.#e.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#s,observer:this});let s=this.hasListeners();s&&b(this.#s,r,this.options,t)&&this.#m(),this.updateResult(),s&&(this.#s!==r||(0,p.Nc)(this.options.enabled,this.#s)!==(0,p.Nc)(t.enabled,this.#s)||(0,p.KC)(this.options.staleTime,this.#s)!==(0,p.KC)(t.staleTime,this.#s))&&this.#x();let i=this.#R();s&&(this.#s!==r||(0,p.Nc)(this.options.enabled,this.#s)!==(0,p.Nc)(t.enabled,this.#s)||i!==this.#p)&&this.#C(i)}getOptimisticResult(e){let t=this.#e.getQueryCache().build(this.#e,e),r=this.createResult(t,e);return(0,p.VS)(this.getCurrentResult(),r)||(this.#n=r,this.#u=this.options,this.#a=this.#s.state),r}getCurrentResult(){return this.#n}trackResult(e,t){return new Proxy(e,{get:(e,r)=>(this.trackProp(r),t?.(r),"promise"!==r||(this.trackProp("data"),this.options.experimental_prefetchInRender||"pending"!==this.#r.status||this.#r.reject(Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(e,r))})}trackProp(e){this.#f.add(e)}getCurrentQuery(){return this.#s}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){let t=this.#e.defaultQueryOptions(e),r=this.#e.getQueryCache().build(this.#e,t);return r.fetch().then(()=>this.createResult(r,t))}fetch(e){return this.#m({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#n))}#m(e){this.#g();let t=this.#s.fetch(this.options,e);return e?.throwOnError||(t=t.catch(p.ZT)),t}#x(){this.#v();let e=(0,p.KC)(this.options.staleTime,this.#s);if(p.sk||this.#n.isStale||!(0,p.PN)(e))return;let t=(0,p.Kp)(this.#n.dataUpdatedAt,e);this.#h=f.mr.setTimeout(()=>{this.#n.isStale||this.updateResult()},t+1)}#R(){return("function"==typeof this.options.refetchInterval?this.options.refetchInterval(this.#s):this.options.refetchInterval)??!1}#C(e){this.#b(),this.#p=e,!p.sk&&!1!==(0,p.Nc)(this.options.enabled,this.#s)&&(0,p.PN)(this.#p)&&0!==this.#p&&(this.#d=f.mr.setInterval(()=>{(this.options.refetchIntervalInBackground||o.j.isFocused())&&this.#m()},this.#p))}#y(){this.#x(),this.#C(this.#R())}#v(){this.#h&&(f.mr.clearTimeout(this.#h),this.#h=void 0)}#b(){this.#d&&(f.mr.clearInterval(this.#d),this.#d=void 0)}createResult(e,t){let r;let s=this.#s,i=this.options,n=this.#n,a=this.#a,u=this.#u,o=e!==s?e.state:this.#i,{state:l}=e,h={...l},f=!1;if(t._optimisticResults){let r=this.hasListeners(),n=!r&&y(e,t),a=r&&b(e,s,t,i);(n||a)&&(h={...h,...(0,c.z)(l.data,e.options)}),"isRestoring"===t._optimisticResults&&(h.fetchStatus="idle")}let{error:m,errorUpdatedAt:v,status:x}=h;r=h.data;let R=!1;if(void 0!==t.placeholderData&&void 0===r&&"pending"===x){let e;n?.isPlaceholderData&&t.placeholderData===u?.placeholderData?(e=n.data,R=!0):e="function"==typeof t.placeholderData?t.placeholderData(this.#c?.state.data,this.#c):t.placeholderData,void 0!==e&&(x="success",r=(0,p.oE)(n?.data,e,t),f=!0)}if(t.select&&void 0!==r&&!R){if(n&&r===a?.data&&t.select===this.#o)r=this.#l;else try{this.#o=t.select,r=t.select(r),r=(0,p.oE)(n?.data,r,t),this.#l=r,this.#t=null}catch(e){this.#t=e}}this.#t&&(m=this.#t,r=this.#l,v=Date.now(),x="error");let C="fetching"===h.fetchStatus,N="pending"===x,S="error"===x,O=N&&C,Q=void 0!==r,_={status:x,fetchStatus:h.fetchStatus,isPending:N,isSuccess:"success"===x,isError:S,isInitialLoading:O,isLoading:O,data:r,dataUpdatedAt:h.dataUpdatedAt,error:m,errorUpdatedAt:v,failureCount:h.fetchFailureCount,failureReason:h.fetchFailureReason,errorUpdateCount:h.errorUpdateCount,isFetched:h.dataUpdateCount>0||h.errorUpdateCount>0,isFetchedAfterMount:h.dataUpdateCount>o.dataUpdateCount||h.errorUpdateCount>o.errorUpdateCount,isFetching:C,isRefetching:C&&!N,isLoadingError:S&&!Q,isPaused:"paused"===h.fetchStatus,isPlaceholderData:f,isRefetchError:S&&Q,isStale:g(e,t),refetch:this.refetch,promise:this.#r,isEnabled:!1!==(0,p.Nc)(t.enabled,e)};if(this.options.experimental_prefetchInRender){let t=e=>{"error"===_.status?e.reject(_.error):void 0!==_.data&&e.resolve(_.data)},r=()=>{t(this.#r=_.promise=(0,d.O)())},i=this.#r;switch(i.status){case"pending":e.queryHash===s.queryHash&&t(i);break;case"fulfilled":("error"===_.status||_.data!==i.value)&&r();break;case"rejected":("error"!==_.status||_.error!==i.reason)&&r()}}return _}updateResult(){let e=this.#n,t=this.createResult(this.#s,this.options);this.#a=this.#s.state,this.#u=this.options,void 0!==this.#a.data&&(this.#c=this.#s),(0,p.VS)(t,e)||(this.#n=t,this.#N({listeners:(()=>{if(!e)return!0;let{notifyOnChangeProps:t}=this.options,r="function"==typeof t?t():t;if("all"===r||!r&&!this.#f.size)return!0;let s=new Set(r??this.#f);return this.options.throwOnError&&s.add("error"),Object.keys(this.#n).some(t=>this.#n[t]!==e[t]&&s.has(t))})()}))}#g(){let e=this.#e.getQueryCache().build(this.#e,this.options);if(e===this.#s)return;let t=this.#s;this.#s=e,this.#i=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#y()}#N(e){l.Vr.batch(()=>{e.listeners&&this.listeners.forEach(e=>{e(this.#n)}),this.#e.getQueryCache().notify({query:this.#s,type:"observerResultsUpdated"})})}};function y(e,t){return!1!==(0,p.Nc)(t.enabled,e)&&void 0===e.state.data&&!("error"===e.state.status&&!1===t.retryOnMount)||void 0!==e.state.data&&v(e,t,t.refetchOnMount)}function v(e,t,r){if(!1!==(0,p.Nc)(t.enabled,e)&&"static"!==(0,p.KC)(t.staleTime,e)){let s="function"==typeof r?r(e):r;return"always"===s||!1!==s&&g(e,t)}return!1}function b(e,t,r,s){return(e!==t||!1===(0,p.Nc)(s.enabled,e))&&(!r.suspense||"error"!==e.state.status)&&g(e,r)}function g(e,t){return!1!==(0,p.Nc)(t.enabled,e)&&e.isStaleByTime((0,p.KC)(t.staleTime,e))}var x=r(2265),R=x.createContext((s=!1,{clearReset:()=>{s=!1},reset:()=>{s=!0},isReset:()=>s})),C=()=>x.useContext(R),N=(e,t)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&!t.isReset()&&(e.retryOnMount=!1)},S=e=>{x.useEffect(()=>{e.clearReset()},[e])},O=e=>{let{result:t,errorResetBoundary:r,throwOnError:s,query:i,suspense:n}=e;return t.isError&&!r.isReset()&&!t.isFetching&&i&&(n&&void 0===t.data||(0,p.L3)(s,[t.error,i]))},Q=x.createContext(!1),_=()=>x.useContext(Q);Q.Provider;var E=e=>{if(e.suspense){let t=e=>"static"===e?e:Math.max(e??1e3,1e3),r=e.staleTime;e.staleTime="function"==typeof r?(...e)=>t(r(...e)):t(r),"number"==typeof e.gcTime&&(e.gcTime=Math.max(e.gcTime,1e3))}},w=(e,t)=>e.isLoading&&e.isFetching&&!t,I=(e,t)=>e?.suspense&&t.isPending,j=(e,t,r)=>t.fetchOptimistic(e).catch(()=>{r.clearReset()}),T=r(2812),P=class extends h.l{#e;#n=void 0;#S;#O;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#Q()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,p.VS)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#S,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,p.Ym)(t.mutationKey)!==(0,p.Ym)(this.options.mutationKey)?this.reset():this.#S?.state.status==="pending"&&this.#S.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#S?.removeObserver(this)}onMutationUpdate(e){this.#Q(),this.#N(e)}getCurrentResult(){return this.#n}reset(){this.#S?.removeObserver(this),this.#S=void 0,this.#Q(),this.#N()}mutate(e,t){return this.#O=t,this.#S?.removeObserver(this),this.#S=this.#e.getMutationCache().build(this.#e,this.options),this.#S.addObserver(this),this.#S.execute(e)}#Q(){let e=this.#S?.state??(0,T.R)();this.#n={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#N(e){l.Vr.batch(()=>{if(this.#O&&this.hasListeners()){let t=this.#n.variables,r=this.#n.context,s={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};e?.type==="success"?(this.#O.onSuccess?.(e.data,t,r,s),this.#O.onSettled?.(e.data,null,t,r,s)):e?.type==="error"&&(this.#O.onError?.(e.error,t,r,s),this.#O.onSettled?.(void 0,e.error,t,r,s))}this.listeners.forEach(e=>{e(this.#n)})})}},k=r(7138),M=r(6463);function U(){var e,t,r,s;let{user:o,loading:c}=(0,n.aC)(),h=(0,u.NL)(),d=(0,M.useSearchParams)(),f=(null==d?void 0:d.get("new"))==="1",[y,v]=(0,x.useState)(f),[b,g]=(0,x.useState)(""),R=(0,x.useMemo)(()=>(0,a.N)(),[]),Q=function(e,t,r){var s,i,n,a,o;let c=_(),h=C(),d=(0,u.NL)(r),f=d.defaultQueryOptions(e);null===(i=d.getDefaultOptions().queries)||void 0===i||null===(s=i._experimental_beforeQuery)||void 0===s||s.call(i,f),f._optimisticResults=c?"isRestoring":"optimistic",E(f),N(f,h),S(h);let m=!d.getQueryCache().get(f.queryHash),[y]=x.useState(()=>new t(d,f)),v=y.getOptimisticResult(f),b=!c&&!1!==e.subscribed;if(x.useSyncExternalStore(x.useCallback(e=>{let t=b?y.subscribe(l.Vr.batchCalls(e)):p.ZT;return y.updateResult(),t},[y,b]),()=>y.getCurrentResult(),()=>y.getCurrentResult()),x.useEffect(()=>{y.setOptions(f)},[f,y]),I(f,v))throw j(f,y,h);if(O({result:v,errorResetBoundary:h,throwOnError:f.throwOnError,query:d.getQueryCache().get(f.queryHash),suspense:f.suspense}))throw v.error;if(null===(a=d.getDefaultOptions().queries)||void 0===a||null===(n=a._experimental_afterQuery)||void 0===n||n.call(a,f,v),f.experimental_prefetchInRender&&!p.sk&&w(v,c)){let e=m?j(f,y,h):null===(o=d.getQueryCache().get(f.queryHash))||void 0===o?void 0:o.promise;null==e||e.catch(p.ZT).finally(()=>{y.updateResult()})}return f.notifyOnChangeProps?v:y.trackResult(v)}({queryKey:["groups",null==o?void 0:o.id],enabled:!!(null==o?void 0:o.id),queryFn:async()=>{if(!(null==o?void 0:o.id))return[];let{data:e,error:t}=await R.from("group_members").select("group:groups(id, name, created_at)").eq("user_id",o.id).eq("is_active",!0).order("group(name)");if(t)throw t;return(null!=e?e:[]).map(e=>e.group).filter(e=>!!e)}},m,void 0),T=function(e,t){let r=(0,u.NL)(void 0),[s]=x.useState(()=>new P(r,e));x.useEffect(()=>{s.setOptions(e)},[s,e]);let i=x.useSyncExternalStore(x.useCallback(e=>s.subscribe(l.Vr.batchCalls(e)),[s]),()=>s.getCurrentResult(),()=>s.getCurrentResult()),n=x.useCallback((e,t)=>{s.mutate(e,t).catch(p.ZT)},[s]);if(i.error&&(0,p.L3)(s.options.throwOnError,[i.error]))throw i.error;return{...i,mutate:n,mutateAsync:i.mutate}}({mutationFn:async e=>{if(!(null==o?void 0:o.id))throw Error("Debes iniciar sesi\xf3n");if(!e.trim())throw Error("Introduce un nombre de grupo");let t={name:e.trim()},{data:r,error:s}=await R.from("groups").insert(t).select("id, name, created_at").single();if(s)throw s;let i={group_id:r.id,user_id:o.id,is_active:!0},{error:n}=await R.from("group_members").insert(i);if(n)throw n;return r},onSuccess:async()=>{await h.invalidateQueries({queryKey:["groups",null==o?void 0:o.id]})}});return c?(0,i.jsx)("main",{className:"p-6 text-sm text-gray-500",children:"Cargando grupos..."}):o?(0,i.jsx)(n.ZP,{children:(0,i.jsxs)("main",{className:"p-6 space-y-6",children:[(0,i.jsxs)("header",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h1",{className:"text-2xl font-semibold",children:"Tus grupos"}),(0,i.jsx)("p",{className:"text-gray-600 text-sm",children:"Crea un grupo nuevo o entra en uno existente."})]}),(0,i.jsx)("button",{className:"bg-black text-white px-4 py-2 rounded",onClick:()=>v(!0),children:"Nuevo grupo"})]}),y&&(0,i.jsxs)("form",{className:"border p-4 rounded space-y-3",onSubmit:function(e){e.preventDefault(),T.mutate(b,{onSuccess:e=>{g(""),v(!1),e&&(window.location.href="/groups/".concat(e.id))}})},children:[(0,i.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:["Nombre del grupo",(0,i.jsx)("input",{className:"border px-3 py-2 rounded",placeholder:"Viaje a la sierra",required:!0,value:b,onChange:e=>g(e.target.value)})]}),(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)("button",{className:"bg-black text-white px-4 py-2 rounded",disabled:T.isPending,type:"submit",children:"Crear y entrar"}),(0,i.jsx)("button",{className:"text-sm text-gray-600",onClick:()=>v(!1),type:"button",children:"Cancelar"})]}),T.error&&(0,i.jsx)("p",{className:"text-sm text-red-600",children:null!==(r=T.error.message)&&void 0!==r?r:"No se pudo crear el grupo"})]}),(0,i.jsxs)("section",{className:"space-y-3",children:[(0,i.jsx)("h2",{className:"text-lg font-semibold",children:"Grupos existentes"}),(0,i.jsx)("ul",{className:"space-y-2",children:null===(e=Q.data)||void 0===e?void 0:e.map(e=>(0,i.jsxs)("li",{className:"border rounded p-3 flex items-center justify-between",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("p",{className:"font-medium",children:e.name}),(0,i.jsxs)("p",{className:"text-xs text-gray-500",children:["Creado ",new Date(e.created_at).toLocaleDateString()]})]}),(0,i.jsx)(k.default,{className:"text-sm text-blue-600",href:"/groups/".concat(e.id),children:"Abrir"})]},e.id))}),Q.isLoading&&(0,i.jsx)("p",{className:"text-sm text-gray-500",children:"Cargando..."}),Q.error&&(0,i.jsx)("p",{className:"text-sm text-red-600",children:null!==(s=Q.error.message)&&void 0!==s?s:"No se pudieron obtener los grupos"}),(null===(t=Q.data)||void 0===t?void 0:t.length)===0&&!Q.isLoading&&(0,i.jsx)("p",{className:"text-sm text-gray-500",children:"Todav\xeda no perteneces a ning\xfan grupo."})]})]})}):null}function L(){return(0,i.jsx)(x.Suspense,{fallback:(0,i.jsx)("div",{children:"Cargando..."}),children:(0,i.jsx)(U,{})})}},683:function(e,t,r){"use strict";r.d(t,{Ho:function(){return l},aC:function(){return c}});var s=r(7437),i=r(4316),n=r(6463),a=r(2265);let u=(0,a.createContext)(void 0);async function o(e){var t;if(!e)return null;let r=(0,i.N)(),{data:s,error:n}=await r.from("profiles").select("id, email, display_name").eq("id",e.id).maybeSingle();if(n)return console.error("Error al comprobar el perfil",n),null!=s?s:null;if(s)return s;let a={id:e.id,email:e.email,display_name:null===(t=e.user_metadata)||void 0===t?void 0:t.display_name},{data:u,error:o}=await (0,i.N)().from("profiles").upsert(a).select("id, email, display_name").single();return o?(console.error("Error al crear el perfil",o),null!=s?s:a):null!=u?u:a}function l(e){let{children:t}=e,r=(0,n.useRouter)(),l=(0,n.usePathname)(),[c,h]=(0,a.useState)(null),[d,p]=(0,a.useState)(null),[f,m]=(0,a.useState)(!0),y=(0,i.N)(),v=(0,a.useCallback)(async()=>{var e,t;m(!0);let{data:r,error:s}=await y.auth.getSession();if(s){console.error("Error al recuperar la sesi\xf3n",s),h(null),p(null),m(!1);return}let i=null!==(e=r.session)&&void 0!==e?e:null;h(i);let n=await o(null!==(t=null==i?void 0:i.user)&&void 0!==t?t:null);p(null!=n?n:null),m(!1)},[y]);(0,a.useEffect)(()=>{let e=!0;v().finally(()=>{e&&m(!1)});let{data:t}=y.auth.onAuthStateChange(async(e,t)=>{var s;h(t);let i=await o(null!==(s=null==t?void 0:t.user)&&void 0!==s?s:null);p(null!=i?i:null),t||"/login"===l?t&&"/login"===l&&r.replace("/"):r.replace("/login")});return()=>{e=!1,t.subscription.unsubscribe()}},[l,v,r,y]);let b=(0,a.useMemo)(()=>{var e;return{session:c,user:null!==(e=null==c?void 0:c.user)&&void 0!==e?e:null,profile:d,loading:f,refresh:v}},[c,d,f,v]);return(0,s.jsx)(u.Provider,{value:b,children:t})}function c(){let e=(0,a.useContext)(u);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}t.ZP=function(e){let{children:t}=e,{loading:r,user:i}=c();return r?(0,s.jsx)("div",{className:"p-6 text-sm text-gray-500",children:"Cargando sesi\xf3n..."}):i?(0,s.jsx)(s.Fragment,{children:t}):null}},4316:function(e,t,r){"use strict";r.d(t,{N:function(){return a}});var s=r(46),i=r(357);let n=globalThis;function a(){let e=i.env.NEXT_PUBLIC_SUPABASE_URL,t=i.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!e||!t)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY environment variables");return n.__supabaseClient||(n.__supabaseClient=(0,s.eI)(e,t)),n.__supabaseClient}}},function(e){e.O(0,[46,291,832,971,23,744],function(){return e(e.s=6325)}),_N_E=e.O()}]);