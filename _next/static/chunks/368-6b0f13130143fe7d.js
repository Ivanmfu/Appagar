"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[368],{4368:function(t,e,s){s.d(e,{a:function(){return d}});var r=s(7437),i=s(683),a=s(4316);async function n(t){let{groupId:e,payerId:s,totalCents:r,currency:i="EUR",fxRate:n=1,shares:o,note:l,category:u,date:c,createdBy:h}=t,d=(0,a.N)(),{data:p,error:m}=await d.from("expenses").insert([{group_id:e,payer_id:s,amount_minor:r,currency:i,fx_rate:n,amount_base_minor:Math.round(r*n),category:u,note:l,date:c,created_by:h}]).select().single();if(m)throw m;if(!p)throw Error("No se pudo crear el gasto");let x=o.map(t=>({expense_id:p.id,user_id:t.userId,share_minor:t.shareCents,is_included:!0})),{error:b}=await d.from("expense_participants").insert(x);if(b)throw b;return p}var o=s(313),l=s(3191),u=s(5524),c=s(2265);function h(t,e){return new Intl.NumberFormat("es-ES",{style:"currency",currency:e}).format(t/100)}function d(t){let{groupId:e,members:s,baseCurrency:a,onSuccess:d}=t,{user:p}=(0,i.aC)(),m=(0,l.NL)(),[x,b]=(0,c.useState)(""),[f,g]=(0,c.useState)(""),[v,y]=(0,c.useState)(()=>new Date().toISOString().slice(0,10)),[w,N]=(0,c.useState)(()=>{var t,e;return null!==(e=null===(t=s[0])||void 0===t?void 0:t.userId)&&void 0!==e?e:""}),[C,j]=(0,c.useState)(()=>s.map(t=>t.userId)),[M,I]=(0,c.useState)(null),[S,E]=(0,c.useState)("equal"),[k,R]=(0,c.useState)({});(0,c.useEffect)(()=>{0!==s.length&&(j(t=>{if(0===t.length)return s.map(t=>t.userId);let e=new Set(s.map(t=>t.userId)),r=t.filter(t=>e.has(t));return r.length>0?r:s.map(t=>t.userId)}),N(t=>{var e,r;return s.some(e=>e.userId===t)?t:null!==(r=null===(e=s[0])||void 0===e?void 0:e.userId)&&void 0!==r?r:t}))},[s]),(0,c.useEffect)(()=>{R(t=>{let e={};return C.forEach(s=>{var r;e[s]=null!==(r=t[s])&&void 0!==r?r:""}),e})},[C]),(0,c.useEffect)(()=>{if("custom"!==S||!x.trim())return;let t=(()=>{let t=Number.parseFloat(x.replace(",","."));return!Number.isFinite(t)||t<=0||0===C.length?[]:(0,o.W)(Math.round(100*t),C.length).map(t=>t/100)})();R(e=>{let s={...e};return C.forEach((e,r)=>{if(!s[e]||"0"===s[e]||"0,00"===s[e]||"0.00"===s[e]){var i;let a=null!==(i=t[r])&&void 0!==i?i:0;s[e]=a>0?a.toFixed(2):""}}),s})},[S,x,C]);let O=(0,u.D)({mutationFn:async()=>{if(I(null),!x.trim())throw Error("Introduce un importe");if(!(null==p?void 0:p.id))throw Error("Necesitas iniciar sesi\xf3n para registrar un gasto");let t=Number.parseFloat(x.replace(",","."));if(!Number.isFinite(t)||t<=0)throw Error("Introduce un importe v\xe1lido");if(0===C.length)throw Error("Selecciona al menos un participante");let s=Math.round(100*t),r=[];if("custom"===S){let t=0;r=C.map(e=>{let s=k[e];if(!s||!s.trim())throw Error("Completa el importe para cada participante en el reparto personalizado");let r=Number.parseFloat(s.replace(",","."));if(!Number.isFinite(r)||r<0)throw Error("Introduce importes v\xe1lidos en el reparto personalizado");let i=Math.round(100*r);return t+=i,{userId:e,shareCents:i}});let e=s-t;if(Math.abs(e)>1)throw Error("El reparto personalizado debe sumar exactamente el total del gasto");r.length>0&&0!==e&&(r[r.length-1].shareCents+=e)}else r=(0,o.W)(s,C.length).map((t,e)=>({userId:C[e],shareCents:t}));return n({groupId:e,payerId:w,totalCents:s,currency:a,shares:r,note:f.trim()?f.trim():void 0,date:v,createdBy:p.id})},onSuccess:async()=>{await Promise.all([m.invalidateQueries({queryKey:["group-detail",e]}),m.invalidateQueries({queryKey:["group-expenses",e]}),m.invalidateQueries({queryKey:["group-balance",e]})]),b(""),g(""),j(s.map(t=>t.userId)),E("equal"),R({}),null==d||d()},onError:t=>{I(t instanceof Error?t.message:"No se pudo registrar el gasto")}}),F=(0,c.useMemo)(()=>{if(!x.trim()||0===C.length)return[];let t=Number.parseFloat(x.replace(",","."));return!Number.isFinite(t)||t<=0?[]:"custom"===S?C.map(t=>{let e=k[t],s=e?Number.parseFloat(e.replace(",",".")):0;return{userId:t,share:Number.isFinite(s)?Math.round(100*s):0}}):(0,o.W)(Math.round(100*t),C.length).map((t,e)=>({userId:C[e],share:t}))},[x,C,S,k]);return(0,r.jsxs)("form",{className:"space-y-5 text-sm text-slate-100",onSubmit:function(t){t.preventDefault(),O.mutate()},children:[(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("h3",{className:"text-base font-semibold text-white",children:"Registrar gasto"}),(0,r.jsx)("p",{className:"text-xs text-slate-300",children:"Selecciona qui\xe9n participa y c\xf3mo quieres repartir el importe."})]}),(0,r.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[(0,r.jsxs)("label",{className:"flex flex-col gap-2",children:[(0,r.jsxs)("span",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-slate-200/80",children:["Importe (",a,")"]}),(0,r.jsx)("input",{className:"rounded-xl border border-white/20 bg-black/30 px-4 py-3 text-sm text-white placeholder:text-slate-400 focus:border-white/40 focus:outline-none",placeholder:"0,00",value:x,onChange:t=>b(t.target.value),inputMode:"decimal",required:!0})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2",children:[(0,r.jsx)("span",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-slate-200/80",children:"Fecha"}),(0,r.jsx)("input",{className:"rounded-xl border border-white/20 bg-black/30 px-4 py-3 text-sm text-white focus:border-white/40 focus:outline-none",type:"date",value:v,onChange:t=>y(t.target.value),required:!0})]})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2",children:[(0,r.jsx)("span",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-slate-200/80",children:"Descripci\xf3n"}),(0,r.jsx)("input",{className:"rounded-xl border border-white/20 bg-black/30 px-4 py-3 text-sm text-white placeholder:text-slate-400 focus:border-white/40 focus:outline-none",placeholder:"Cena del viernes",value:f,onChange:t=>g(t.target.value)})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2",children:[(0,r.jsx)("span",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-slate-200/80",children:"Pagado por"}),(0,r.jsx)("select",{className:"rounded-xl border border-white/20 bg-black/30 px-4 py-3 text-sm text-white focus:border-white/40 focus:outline-none",value:w,onChange:t=>N(t.target.value),children:s.map(t=>{var e,s;return(0,r.jsx)("option",{value:t.userId,children:null!==(s=null!==(e=t.displayName)&&void 0!==e?e:t.email)&&void 0!==s?s:"Miembro"},t.userId)})})]}),(0,r.jsxs)("fieldset",{className:"space-y-3",children:[(0,r.jsx)("legend",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-slate-200/80",children:"Tipo de reparto"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,r.jsx)("button",{type:"button",className:"rounded-full px-4 py-2 text-xs font-semibold transition ".concat("equal"===S?"bg-white/80 text-slate-900 shadow shadow-white/40":"border border-white/30 bg-black/30 text-slate-200/80 hover:border-white/50 hover:text-white"),onClick:()=>E("equal"),children:"Reparto igualitario"}),(0,r.jsx)("button",{type:"button",className:"rounded-full px-4 py-2 text-xs font-semibold transition ".concat("custom"===S?"bg-white/80 text-slate-900 shadow shadow-white/40":"border border-white/30 bg-black/30 text-slate-200/80 hover:border-white/50 hover:text-white"),onClick:()=>E("custom"),children:"Reparto personalizado $          "})]})]}),(0,r.jsxs)("fieldset",{className:"space-y-3",children:[(0,r.jsx)("legend",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-slate-200/80",children:"Participantes"}),(0,r.jsx)("div",{className:"grid gap-3 md:grid-cols-2",children:s.map(t=>{var e,s,i,n,o;let l=C.includes(t.userId);return(0,r.jsxs)("label",{className:"flex items-center gap-3 rounded-2xl border px-4 py-3 transition ".concat(l?"border-white/40 bg-white/10":"border-white/10 bg-black/20 hover:border-white/30 hover:bg-white/10"),children:[(0,r.jsx)("input",{type:"checkbox",className:"h-4 w-4 rounded border-white/30 bg-black/40 text-indigo-400 focus:ring-indigo-300",checked:l,onChange:()=>{var e;return e=t.userId,void j(t=>{if(t.includes(e)){let s=t.filter(t=>t!==e);return 0===s.length?t:s}return[...t,e]})}}),(0,r.jsxs)("span",{className:"text-sm text-slate-100",children:[null!==(i=null!==(s=t.displayName)&&void 0!==s?s:t.email)&&void 0!==i?i:"Miembro",l&&F.length>0&&(0,r.jsx)("span",{className:"block text-xs text-slate-300",children:h(null!==(n=null===(e=F.find(e=>e.userId===t.userId))||void 0===e?void 0:e.share)&&void 0!==n?n:0,a)})]}),"custom"===S&&l&&(0,r.jsx)("input",{className:"mt-2 w-full rounded-xl border border-white/20 bg-black/40 px-3 py-2 text-sm text-white placeholder:text-slate-400 focus:border-white/40 focus:outline-none",placeholder:"0,00",value:null!==(o=k[t.userId])&&void 0!==o?o:"",onChange:e=>R(s=>({...s,[t.userId]:e.target.value})),inputMode:"decimal"})]},t.userId)})})]}),M&&(0,r.jsx)("p",{className:"text-sm text-red-300",children:M}),(0,r.jsx)("button",{className:"rounded-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 px-6 py-2 text-sm font-semibold text-white shadow-lg shadow-purple-500/30 transition hover:scale-105 disabled:cursor-not-allowed disabled:opacity-60",disabled:O.isPending,type:"submit",children:O.isPending?"Guardando...":"Guardar gasto"}),F.length>0&&(0,r.jsxs)("p",{className:"text-xs text-slate-300",children:["Cada participante aporta aproximadamente ",h(F[0].share,a)]})]})}},2812:function(t,e,s){s.d(e,{R:function(){return o},m:function(){return n}});var r=s(9948),i=s(3494),a=s(924),n=class extends i.F{#t;#e;#s;#r;constructor(t){super(),this.#t=t.client,this.mutationId=t.mutationId,this.#s=t.mutationCache,this.#e=[],this.state=t.state||o(),this.setOptions(t.options),this.scheduleGc()}setOptions(t){this.options=t,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(t){this.#e.includes(t)||(this.#e.push(t),this.clearGcTimeout(),this.#s.notify({type:"observerAdded",mutation:this,observer:t}))}removeObserver(t){this.#e=this.#e.filter(e=>e!==t),this.scheduleGc(),this.#s.notify({type:"observerRemoved",mutation:this,observer:t})}optionalRemove(){this.#e.length||("pending"===this.state.status?this.scheduleGc():this.#s.remove(this))}continue(){return this.#r?.continue()??this.execute(this.state.variables)}async execute(t){let e=()=>{this.#i({type:"continue"})},s={client:this.#t,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#r=(0,a.Mz)({fn:()=>this.options.mutationFn?this.options.mutationFn(t,s):Promise.reject(Error("No mutationFn found")),onFail:(t,e)=>{this.#i({type:"failed",failureCount:t,error:e})},onPause:()=>{this.#i({type:"pause"})},onContinue:e,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#s.canRun(this)});let r="pending"===this.state.status,i=!this.#r.canStart();try{if(r)e();else{this.#i({type:"pending",variables:t,isPaused:i}),await this.#s.config.onMutate?.(t,this,s);let e=await this.options.onMutate?.(t,s);e!==this.state.context&&this.#i({type:"pending",context:e,variables:t,isPaused:i})}let a=await this.#r.start();return await this.#s.config.onSuccess?.(a,t,this.state.context,this,s),await this.options.onSuccess?.(a,t,this.state.context,s),await this.#s.config.onSettled?.(a,null,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(a,null,t,this.state.context,s),this.#i({type:"success",data:a}),a}catch(e){try{throw await this.#s.config.onError?.(e,t,this.state.context,this,s),await this.options.onError?.(e,t,this.state.context,s),await this.#s.config.onSettled?.(void 0,e,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(void 0,e,t,this.state.context,s),e}finally{this.#i({type:"error",error:e})}}finally{this.#s.runNext(this)}}#i(t){this.state=(e=>{switch(t.type){case"failed":return{...e,failureCount:t.failureCount,failureReason:t.error};case"pause":return{...e,isPaused:!0};case"continue":return{...e,isPaused:!1};case"pending":return{...e,context:t.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:t.isPaused,status:"pending",variables:t.variables,submittedAt:Date.now()};case"success":return{...e,data:t.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...e,data:void 0,error:t.error,failureCount:e.failureCount+1,failureReason:t.error,isPaused:!1,status:"error"}}})(this.state),r.Vr.batch(()=>{this.#e.forEach(e=>{e.onMutationUpdate(t)}),this.#s.notify({mutation:this,type:"updated",action:t})})}};function o(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}},5524:function(t,e,s){s.d(e,{D:function(){return c}});var r=s(2265),i=s(2812),a=s(9948),n=s(9010),o=s(6298),l=class extends n.l{#t;#a=void 0;#n;#o;constructor(t,e){super(),this.#t=t,this.setOptions(e),this.bindMethods(),this.#l()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){let e=this.options;this.options=this.#t.defaultMutationOptions(t),(0,o.VS)(this.options,e)||this.#t.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#n,observer:this}),e?.mutationKey&&this.options.mutationKey&&(0,o.Ym)(e.mutationKey)!==(0,o.Ym)(this.options.mutationKey)?this.reset():this.#n?.state.status==="pending"&&this.#n.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#n?.removeObserver(this)}onMutationUpdate(t){this.#l(),this.#u(t)}getCurrentResult(){return this.#a}reset(){this.#n?.removeObserver(this),this.#n=void 0,this.#l(),this.#u()}mutate(t,e){return this.#o=e,this.#n?.removeObserver(this),this.#n=this.#t.getMutationCache().build(this.#t,this.options),this.#n.addObserver(this),this.#n.execute(t)}#l(){let t=this.#n?.state??(0,i.R)();this.#a={...t,isPending:"pending"===t.status,isSuccess:"success"===t.status,isError:"error"===t.status,isIdle:"idle"===t.status,mutate:this.mutate,reset:this.reset}}#u(t){a.Vr.batch(()=>{if(this.#o&&this.hasListeners()){let e=this.#a.variables,s=this.#a.context,r={client:this.#t,meta:this.options.meta,mutationKey:this.options.mutationKey};t?.type==="success"?(this.#o.onSuccess?.(t.data,e,s,r),this.#o.onSettled?.(t.data,null,e,s,r)):t?.type==="error"&&(this.#o.onError?.(t.error,e,s,r),this.#o.onSettled?.(void 0,t.error,e,s,r))}this.listeners.forEach(t=>{t(this.#a)})})}},u=s(3191);function c(t,e){let s=(0,u.NL)(e),[i]=r.useState(()=>new l(s,t));r.useEffect(()=>{i.setOptions(t)},[i,t]);let n=r.useSyncExternalStore(r.useCallback(t=>i.subscribe(a.Vr.batchCalls(t)),[i]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),c=r.useCallback((t,e)=>{i.mutate(t,e).catch(o.ZT)},[i]);if(n.error&&(0,o.L3)(i.options.throwOnError,[n.error]))throw n.error;return{...n,mutate:c,mutateAsync:n.mutate}}}}]);