(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[663],{8986:function(e,t,s){Promise.resolve().then(s.bind(s,2838))},2838:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return f}});var a=s(7437),r=s(683);function i(e,t){return new Intl.NumberFormat("es-ES",{style:"currency",currency:t}).format(e/100)}function n(e){let{baseCurrency:t,members:s,balance:r}=e,n=new Map(s.map(e=>[e.userId,e]));return(0,a.jsxs)("section",{className:"space-y-4",children:[(0,a.jsxs)("header",{children:[(0,a.jsx)("h3",{className:"text-base font-semibold",children:"Balance del grupo"}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:"C\xe1lculo con la vista group_balance y simplificaci\xf3n de deudas."})]}),(0,a.jsxs)("div",{className:"grid gap-2 md:grid-cols-2",children:[0===r.balances.length&&(0,a.jsx)("p",{className:"text-sm text-gray-500 col-span-full",children:"No hay movimientos registrados todav\xeda."}),r.balances.map(e=>{var s,r;let l=n.get(e.user_id),o=null!==(r=null!==(s=null==l?void 0:l.displayName)&&void 0!==s?s:null==l?void 0:l.email)&&void 0!==r?r:"Miembro",c=i(e.net_minor,t),d=e.net_minor>=0;return(0,a.jsxs)("div",{className:"border rounded p-3 text-sm ".concat(d?"border-green-200 bg-green-50":"border-red-200 bg-red-50"),children:[(0,a.jsx)("p",{className:"font-medium",children:o}),(0,a.jsxs)("p",{className:d?"text-green-700":"text-red-700",children:[d?"Recibe":"Debe"," ",c]})]},e.user_id)})]}),r.transactions.length>0&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h4",{className:"text-sm font-semibold",children:"Liquidaciones sugeridas"}),(0,a.jsx)("ul",{className:"space-y-1 text-sm",children:r.transactions.map((e,s)=>{var r,l,o,c,d,m,u,x;let p=null!==(m=null!==(d=null===(r=n.get(e.from))||void 0===r?void 0:r.displayName)&&void 0!==d?d:null===(l=n.get(e.from))||void 0===l?void 0:l.email)&&void 0!==m?m:"Alguien",h=null!==(x=null!==(u=null===(o=n.get(e.to))||void 0===o?void 0:o.displayName)&&void 0!==u?u:null===(c=n.get(e.to))||void 0===c?void 0:c.email)&&void 0!==x?x:"Alguien";return(0,a.jsxs)("li",{children:[p," → ",h,": ",i(e.amount,t)]},"".concat(e.from,"-").concat(e.to,"-").concat(s))})})]})]})}var l=s(4368);function o(e){let{expenses:t,baseCurrency:s}=e;return 0===t.length?(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"No hay gastos registrados todav\xeda."}):(0,a.jsx)("ul",{className:"space-y-3",children:t.map(e=>{var t,r,i;return(0,a.jsxs)("li",{className:"border rounded-lg p-4 space-y-2",children:[(0,a.jsxs)("div",{className:"flex flex-wrap justify-between gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:e.date?new Date(e.date).toLocaleDateString():"Sin fecha"}),e.note&&(0,a.jsx)("p",{className:"font-medium",children:e.note})]}),(0,a.jsx)("p",{className:"text-base font-semibold",children:(r=e.amountMinor,i=e.currency||s,new Intl.NumberFormat("es-ES",{style:"currency",currency:i}).format(r/100))})]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:["Pagado por ",null!==(t=e.payerName)&&void 0!==t?t:"Alguien"]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:[(0,a.jsx)("span",{className:"font-medium",children:"Participantes:"})," ",e.participants.length>0?e.participants.map(e=>{var t,s;return null!==(s=null!==(t=e.displayName)&&void 0!==t?t:e.email)&&void 0!==s?s:"Miembro"}).join(", "):"—"]})]},e.id)})})}var c=s(1446),d=s(3191),m=s(5524),u=s(2265);function x(e){let{groupId:t,createdBy:s}=e,r=(0,d.NL)(),[i,n]=(0,u.useState)(""),[l,o]=(0,u.useState)(null),[x,p]=(0,u.useState)(null),h=(0,m.D)({mutationFn:async()=>{p(null);let e=await (0,c.Zn)({groupId:t,email:i,createdBy:s}),a=window.location.origin,r="/Appagar",n=r.endsWith("/")?r.slice(0,-1):r;return o("".concat(a).concat(n,"/invite?token=").concat(e.token)),e},onSuccess:async()=>{await r.invalidateQueries({queryKey:["group-detail",t]}),n("")},onError:e=>{p(e instanceof Error?e.message:"No se pudo enviar la invitaci\xf3n")}});async function g(){if(l)try{await navigator.clipboard.writeText(l)}catch(e){console.error("No se pudo copiar el enlace",e)}}return(0,a.jsxs)("form",{className:"space-y-3",onSubmit:function(e){e.preventDefault(),h.mutate()},children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-base font-semibold",children:"Invitar miembro"}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:"Enviaremos un enlace v\xe1lido durante 48 horas."})]}),(0,a.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:["Email de la persona",(0,a.jsx)("input",{className:"border rounded px-3 py-2",placeholder:"persona@email.com",type:"email",value:i,onChange:e=>n(e.target.value),required:!0})]}),x&&(0,a.jsx)("p",{className:"text-sm text-red-600",children:x}),(0,a.jsx)("button",{className:"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-60",disabled:h.isPending,type:"submit",children:h.isPending?"Enviando...":"Generar invitaci\xf3n"}),l&&(0,a.jsxs)("div",{className:"border rounded p-3 text-sm space-y-2",children:[(0,a.jsx)("p",{className:"font-medium",children:"Invitaci\xf3n generada"}),(0,a.jsx)("p",{className:"break-all text-gray-600",children:l}),(0,a.jsx)("button",{className:"text-blue-600 hover:underline",type:"button",onClick:g,children:"Copiar enlace"})]})]})}var p=s(6294),h=s(5118),g=s(7138),v=s(6463);let b="rounded-3xl border border-white/10 bg-white/10 p-6 backdrop-blur-xl shadow-xl shadow-black/20";function N(e){if(!e)return"—";try{return new Date(e).toLocaleDateString()}catch(e){return"—"}}function f(e){var t,s;let{searchParams:i}=e,{user:c}=(0,r.aC)(),d=(0,v.useRouter)(),m=null==i?void 0:i.id,f=(0,u.useMemo)(()=>m?Array.isArray(m)?m[0]:m:null,[m]);(0,u.useEffect)(()=>{f||d.replace("/grupos")},[f,d]);let j=(0,h.a)({queryKey:["group-detail",f],enabled:!!f,queryFn:async()=>{if(!f)throw Error("Grupo no encontrado");return(0,p.JM)(f)},staleTime:3e4}),w=(0,u.useMemo)(()=>{var e,t;return(null!==(t=null===(e=j.data)||void 0===e?void 0:e.invites)&&void 0!==t?t:[]).filter(e=>"pending"===e.status&&(!e.expiresAt||new Date(e.expiresAt)>new Date))},[null===(t=j.data)||void 0===t?void 0:t.invites]);if(!f)return(0,a.jsx)("div",{className:b,children:(0,a.jsx)("p",{className:"text-sm text-slate-200/80",children:"Redirigiendo a tus grupos..."})});if(j.isLoading)return(0,a.jsx)("div",{className:b,children:(0,a.jsx)("p",{className:"text-sm text-slate-200/80",children:"Cargando detalles del grupo..."})});if(j.isError)return(0,a.jsxs)("div",{className:"".concat(b," space-y-4"),children:[(0,a.jsx)("p",{className:"text-sm text-red-300",children:null!==(s=j.error.message)&&void 0!==s?s:"No se pudieron obtener los detalles del grupo"}),(0,a.jsx)(g.default,{className:"inline-flex items-center text-sm text-indigo-200 underline-offset-2 hover:text-white hover:underline",href:"/grupos",children:"Volver a grupos"})]});let y=j.data;return y?(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(g.default,{className:"inline-flex items-center gap-2 text-sm text-indigo-200 underline-offset-2 hover:text-white hover:underline",href:"/grupos",children:"← Volver a mis grupos"}),(0,a.jsxs)("section",{className:"".concat(b," space-y-4"),children:[(0,a.jsxs)("header",{className:"space-y-1",children:[(0,a.jsx)("h2",{className:"text-2xl font-semibold text-white",children:y.group.name}),(0,a.jsxs)("p",{className:"text-sm text-slate-200/80",children:["Base ",y.group.base_currency," \xb7 ",y.members.length," miembros \xb7 Creado ",N(y.group.created_at)]})]}),(0,a.jsxs)("div",{className:"grid gap-3 text-xs text-slate-200/70 sm:grid-cols-3",children:[(0,a.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-black/30",children:[(0,a.jsx)("p",{className:"uppercase tracking-[0.2em] text-slate-300",children:"Propietario"}),(0,a.jsx)("p",{className:"mt-1 text-sm text-white/90",children:y.group.created_by})]}),(0,a.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-black/30",children:[(0,a.jsx)("p",{className:"uppercase tracking-[0.2em] text-slate-300",children:"Movimientos"}),(0,a.jsx)("p",{className:"mt-1 text-sm text-white/90",children:y.expenses.length})]}),(0,a.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-black/30",children:[(0,a.jsx)("p",{className:"uppercase tracking-[0.2em] text-slate-300",children:"Invitaciones"}),(0,a.jsx)("p",{className:"mt-1 text-sm text-white/90",children:w.length})]})]})]}),(0,a.jsxs)("section",{className:"".concat(b," space-y-4"),children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:"Miembros activos"}),0===y.members.length?(0,a.jsx)("p",{className:"text-sm text-slate-200/70",children:"Todav\xeda no hay miembros activos en el grupo."}):(0,a.jsx)("ul",{className:"grid gap-3 md:grid-cols-2",children:y.members.map(e=>{var t,s;return(0,a.jsxs)("li",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[(0,a.jsx)("p",{className:"text-sm font-semibold text-white",children:null!==(s=null!==(t=e.displayName)&&void 0!==t?t:e.email)&&void 0!==s?s:"Miembro"}),e.email&&(0,a.jsx)("p",{className:"text-xs text-slate-300",children:e.email}),e.role&&(0,a.jsxs)("p",{className:"text-xs text-slate-400",children:["Rol: ",e.role]}),(0,a.jsxs)("p",{className:"mt-2 text-xs text-slate-400",children:["Desde ",N(e.joinedAt)]})]},e.userId)})})]}),(0,a.jsxs)("section",{className:"".concat(b," space-y-4"),children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:"Gastos recientes"}),(0,a.jsx)(o,{baseCurrency:y.group.base_currency,expenses:y.expenses})]}),(0,a.jsxs)("section",{className:"".concat(b," space-y-4"),children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:"Registrar gasto"}),y.members.length>0&&(null==c?void 0:c.id)?(0,a.jsx)(l.a,{baseCurrency:y.group.base_currency,groupId:y.group.id,members:y.members}):(0,a.jsx)("p",{className:"text-sm text-slate-200/70",children:"A\xf1ade miembros antes de registrar nuevos gastos."})]}),(0,a.jsxs)("section",{className:"".concat(b," space-y-4"),children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:"Balance del grupo"}),(0,a.jsx)(n,{balance:y.balances,baseCurrency:y.group.base_currency,members:y.members})]}),(0,a.jsxs)("section",{className:"".concat(b," space-y-6"),children:[(null==c?void 0:c.id)?(0,a.jsx)(x,{createdBy:c.id,groupId:y.group.id}):(0,a.jsx)("p",{className:"text-sm text-slate-200/70",children:"Necesitas iniciar sesi\xf3n para enviar invitaciones."}),w.length>0&&(0,a.jsxs)("div",{className:"space-y-3 text-sm text-slate-100",children:[(0,a.jsx)("h4",{className:"font-semibold text-white",children:"Invitaciones pendientes"}),(0,a.jsx)("ul",{className:"grid gap-3 md:grid-cols-2",children:w.map(e=>(0,a.jsxs)("li",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[(0,a.jsx)("p",{className:"font-medium text-white",children:e.email}),(0,a.jsxs)("p",{className:"text-xs text-slate-300",children:["Expira ",N(e.expiresAt)]})]},e.id))})]})]})]}):(0,a.jsxs)("div",{className:b,children:[(0,a.jsx)("p",{className:"text-sm text-red-300",children:"El grupo no existe o no tienes acceso."}),(0,a.jsx)(g.default,{className:"mt-4 inline-block text-sm text-indigo-200 underline-offset-2 hover:text-white hover:underline",href:"/grupos",children:"Volver a grupos"})]})}},1446:function(e,t,s){"use strict";s.d(t,{O$:function(){return i},Ol:function(){return l},Zn:function(){return r},e$:function(){return n}});var a=s(4316);async function r(e){let{groupId:t,email:s,createdBy:r,expiresInHours:i=48}=e;if(!s.trim())throw Error("Introduce un email para invitar");let n=(0,a.N)(),l=s.trim().toLowerCase(),o=crypto.randomUUID(),c=new Date(Date.now()+36e5*i).toISOString(),{data:d,error:m}=await n.from("group_invites").insert({group_id:t,email:l,token:o,status:"pending",expires_at:c,created_by:r}).select().single();if(m)throw m;return d}async function i(e){if(!e.trim())return null;let t=(0,a.N)(),{data:s,error:r}=await t.from("group_invites").select("id, group_id, email, status, token, expires_at, created_at").eq("token",e).maybeSingle();if(r)throw r;return s}async function n(e){if(!e)return[];let t=(0,a.N)(),s=new Date().toISOString(),{data:r,error:i}=await t.from("group_invites").select("id, group_id, email, status, token, expires_at, created_at").eq("email",e.toLowerCase()).eq("status","pending").gt("expires_at",s).order("created_at",{ascending:!1}).limit(20);if(i)throw i;return(null!=r?r:[]).map(e=>{var t,s;return{id:e.id,groupId:e.group_id,email:e.email,status:e.status,token:e.token,expiresAt:null!==(t=e.expires_at)&&void 0!==t?t:null,createdAt:null!==(s=e.created_at)&&void 0!==s?s:null}})}async function l(e){let{token:t,userId:s}=e,r=(0,a.N)(),n=await i(t);if(!n)throw Error("La invitaci\xf3n no existe o ya fue utilizada");if("pending"!==n.status)throw Error("Esta invitaci\xf3n ya no est\xe1 disponible");if(n.expires_at&&new Date(n.expires_at)<new Date)throw Error("La invitaci\xf3n ha expirado");let{data:l,error:o}=await r.from("group_members").select("id, is_active").eq("group_id",n.group_id).eq("user_id",s).maybeSingle();if(o)throw o;if(l){if(!l.is_active){let{error:e}=await r.from("group_members").update({is_active:!0}).eq("id",l.id);if(e)throw e}}else{let{error:e}=await r.from("group_members").insert({group_id:n.group_id,user_id:s,is_active:!0});if(e)throw e}let{error:c}=await r.from("group_invites").update({status:"accepted"}).eq("id",n.id);if(c)throw c;return n.group_id}}},function(e){e.O(0,[543,973,586,194,368,971,23,744],function(){return e(e.s=8986)}),_N_E=e.O()}]);