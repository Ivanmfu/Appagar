(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[531],{5020:function(e,t,s){Promise.resolve().then(s.bind(s,3020))},3020:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return u}});var i=s(7437),r=s(683),n=s(4316),o=s(5524),a=s(6463);let l="rounded-3xl border border-white/10 bg-white/10 p-6 backdrop-blur-xl shadow-xl shadow-black/20";function u(){var e,t,s,u;let{profile:c,user:h,refresh:d}=(0,r.aC)(),m=(0,a.useRouter)(),p=(0,o.D)({mutationFn:async()=>{let e=(0,n.N)();await e.auth.signOut()},onSuccess:()=>{d(),m.push("/login")}});return(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("section",{className:"".concat(l," space-y-4"),children:[(0,i.jsx)("h2",{className:"text-lg font-semibold text-white",children:"Informaci\xf3n de la cuenta"}),(0,i.jsxs)("dl",{className:"grid gap-4 sm:grid-cols-2",children:[(0,i.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[(0,i.jsx)("dt",{className:"text-xs uppercase tracking-[0.25em] text-slate-300",children:"Nombre"}),(0,i.jsx)("dd",{className:"mt-2 text-sm text-white/90",children:null!==(e=null==c?void 0:c.display_name)&&void 0!==e?e:"—"})]}),(0,i.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[(0,i.jsx)("dt",{className:"text-xs uppercase tracking-[0.25em] text-slate-300",children:"Correo"}),(0,i.jsx)("dd",{className:"mt-2 text-sm text-white/90",children:null!==(s=null!==(t=null==c?void 0:c.email)&&void 0!==t?t:null==h?void 0:h.email)&&void 0!==s?s:"—"})]}),(0,i.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[(0,i.jsx)("dt",{className:"text-xs uppercase tracking-[0.25em] text-slate-300",children:"Identificador"}),(0,i.jsx)("dd",{className:"mt-2 text-sm text-white/90 break-all",children:null!==(u=null==h?void 0:h.id)&&void 0!==u?u:"—"})]}),(0,i.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[(0,i.jsx)("dt",{className:"text-xs uppercase tracking-[0.25em] text-slate-300",children:"Estado"}),(0,i.jsx)("dd",{className:"mt-2 text-sm text-emerald-200",children:h?"Sesi\xf3n activa":"Sesi\xf3n cerrada"})]})]}),(0,i.jsx)("div",{className:"flex flex-wrap gap-3",children:(0,i.jsx)("button",{className:"rounded-full border border-white/20 px-5 py-2 text-sm font-medium text-white/80 transition hover:border-white/40 hover:text-white",onClick:()=>d(),type:"button",children:"Refrescar sesi\xf3n"})})]}),(0,i.jsxs)("section",{className:"".concat(l," space-y-4 border-red-500/40 bg-red-500/10 text-red-100"),children:[(0,i.jsx)("h2",{className:"text-lg font-semibold",children:"Cerrar sesi\xf3n"}),(0,i.jsx)("p",{className:"text-sm",children:"Cierra tu sesi\xf3n actual en este dispositivo. Podr\xe1s volver a iniciar sesi\xf3n en cualquier momento."}),(0,i.jsx)("button",{className:"rounded-full bg-red-500 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-red-500/30 transition hover:bg-red-400 disabled:opacity-60",disabled:p.isPending,onClick:()=>p.mutate(),type:"button",children:p.isPending?"Cerrando...":"Cerrar sesi\xf3n"})]})]})}},683:function(e,t,s){"use strict";s.d(t,{Ho:function(){return u},aC:function(){return c}});var i=s(7437),r=s(4316),n=s(6463),o=s(2265);let a=(0,o.createContext)(void 0);async function l(e){var t,s;if(console.log("[ensureProfile] Called with user:",null==e?void 0:e.email),!e)return console.log("[ensureProfile] No user, returning null"),null;let i={id:e.id,email:e.email,display_name:(null===(t=e.user_metadata)||void 0===t?void 0:t.display_name)||(null===(s=e.user_metadata)||void 0===s?void 0:s.full_name)||null};try{let t=(0,r.N)();console.log("[ensureProfile] Fetching profile from DB with 3s timeout...");let s=t.from("profiles").select("id, email, display_name").eq("id",e.id).maybeSingle(),n=new Promise((e,t)=>setTimeout(()=>t(Error("Profile fetch timeout")),3e3)),{data:o,error:a}=await Promise.race([s,n]);if(console.log("[ensureProfile] DB query result:",{existing:o,fetchError:a}),a)return console.error("[Profile] Error fetching profile:",a),console.log("[ensureProfile] Returning fallback after fetch error"),i;if(o)return console.log("[ensureProfile] Profile found:",o),o;console.log("[ensureProfile] No profile found, attempting background create...");let l={id:e.id,email:e.email,display_name:i.display_name};return(0,r.N)().from("profiles").upsert(l).select("id, email, display_name").single().then(e=>{let{data:t,error:s}=e;s?console.error("[Profile] Background upsert error:",s):console.log("[Profile] Background upsert success:",t)}),console.log("[ensureProfile] Returning fallback immediately"),i}catch(e){return console.error("[Profile] Error or timeout:",e),console.log("[ensureProfile] Returning fallback after exception"),i}}function u(e){let{children:t}=e,s=(0,n.useRouter)(),u=(0,n.usePathname)(),[c,h]=(0,o.useState)(null),[d,m]=(0,o.useState)(null),[p,f]=(0,o.useState)(!0),g=(0,o.useRef)(!1),v=(0,o.useMemo)(()=>(0,r.N)(),[]),b=(0,o.useCallback)(async()=>{console.log("[Auth] refresh() called");try{var e,t;let{data:s,error:i}=await v.auth.getSession();if(i){console.error("Error al recuperar la sesi\xf3n",i),h(null),m(null);return}let r=null!==(e=s.session)&&void 0!==e?e:null;h(r);let n=await l(null!==(t=null==r?void 0:r.user)&&void 0!==t?t:null);m(null!=n?n:null)}catch(e){console.error("Error inesperado al recuperar sesi\xf3n:",e),h(null),m(null)}finally{f(!1)}},[v]);(0,o.useEffect)(()=>{if(g.current)return;g.current=!0;let e=!0,t=setTimeout(()=>{e&&(console.warn("[Auth] TIMEOUT: Forcing loading=false after 10 seconds"),f(!1))},1e4);(async()=>{console.log("[Auth] Initializing...");try{var s,i,r,n;let{data:t,error:o}=await v.auth.getSession();if(console.log("[Auth] getSession result:",{hasSession:!!t.session,error:o,userId:null===(i=t.session)||void 0===i?void 0:null===(s=i.user)||void 0===s?void 0:s.id,email:null===(n=t.session)||void 0===n?void 0:null===(r=n.user)||void 0===r?void 0:r.email}),!e)return;if(o&&console.error("[Auth] Error getting session:",o),h(t.session),t.session){console.log("[Auth] User found:",t.session.user.email),console.log("[Auth] Calling ensureProfile...");let e=await l(t.session.user);console.log("[Auth] ensureProfile returned:",e),m(e),console.log("[Auth] Profile loaded and state updated")}}catch(e){console.error("[Auth] Error in initialize:",e)}finally{clearTimeout(t),e&&(console.log("[Auth] Setting loading=false"),f(!1))}})();let{data:s}=v.auth.onAuthStateChange(async(t,s)=>{if(e){console.log("[Auth] Event:",t,"Has session:",!!s);try{if(h(s),null==s?void 0:s.user){console.log("[Auth] Loading profile for:",s.user.email);let e=await l(s.user);m(e),console.log("[Auth] Profile loaded in event handler")}else m(null)}catch(e){console.error("[Auth] Error in event handler:",e)}finally{console.log("[Auth] Event handler setting loading=false"),f(!1)}}});return()=>{e=!1,s.subscription.unsubscribe()}},[v]),(0,o.useEffect)(()=>{!p&&(c||"/login"===u?c&&"/login"===u&&s.replace("/"):s.replace("/login"))},[u,c,p,s]);let x=(0,o.useMemo)(()=>{var e;return{session:c,user:null!==(e=null==c?void 0:c.user)&&void 0!==e?e:null,profile:d,loading:p,refresh:b}},[c,d,p,b]);return(0,i.jsx)(a.Provider,{value:x,children:t})}function c(){let e=(0,o.useContext)(a);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}t.ZP=function(e){let{children:t}=e,{loading:s,user:r}=c(),a=(0,n.useRouter)();return((0,o.useEffect)(()=>{console.log("AuthGate - loading:",s,"user:",!!r),s||r||(console.log("AuthGate - Redirigiendo a login"),a.replace("/login"))},[s,r,a]),s)?(0,i.jsxs)("div",{className:"p-6 text-center space-y-4",children:[(0,i.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),(0,i.jsx)("div",{className:"text-gray-500",children:"Comprobando sesi\xf3n..."}),(0,i.jsx)("div",{className:"text-xs text-gray-400",children:"Si esto tarda mucho, recarga la p\xe1gina"})]}):r?(0,i.jsx)(i.Fragment,{children:t}):null}},4316:function(e,t,s){"use strict";s.d(t,{N:function(){return n}});var i=s(46);let r=globalThis;function n(){let e="https://hlhcpdymkqhqpsaafthm.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsaGNwZHlta3FocXBzYWFmdGhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NDA0MTgsImV4cCI6MjA3ODExNjQxOH0.H_6vnlgCcT_gxmKK9MSOpI9w-p49VnsTV5WZtNcAmys";if(!e||!t)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY environment variables");return r.__supabaseClient||(r.__supabaseClient=(0,i.eI)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,flowType:"pkce",detectSessionInUrl:!0,storage:window.localStorage,storageKey:"appagar-auth"},global:{headers:{"x-client-info":"appagar-web"}},db:{schema:"public"},realtime:{params:{eventsPerSecond:2}}})),r.__supabaseClient}},2812:function(e,t,s){"use strict";s.d(t,{R:function(){return a},m:function(){return o}});var i=s(9948),r=s(3494),n=s(924),o=class extends r.F{#e;#t;#s;#i;constructor(e){super(),this.#e=e.client,this.mutationId=e.mutationId,this.#s=e.mutationCache,this.#t=[],this.state=e.state||a(),this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options=e,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(e){this.#t.includes(e)||(this.#t.push(e),this.clearGcTimeout(),this.#s.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.#t=this.#t.filter(t=>t!==e),this.scheduleGc(),this.#s.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.#t.length||("pending"===this.state.status?this.scheduleGc():this.#s.remove(this))}continue(){return this.#i?.continue()??this.execute(this.state.variables)}async execute(e){let t=()=>{this.#r({type:"continue"})},s={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#i=(0,n.Mz)({fn:()=>this.options.mutationFn?this.options.mutationFn(e,s):Promise.reject(Error("No mutationFn found")),onFail:(e,t)=>{this.#r({type:"failed",failureCount:e,error:t})},onPause:()=>{this.#r({type:"pause"})},onContinue:t,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#s.canRun(this)});let i="pending"===this.state.status,r=!this.#i.canStart();try{if(i)t();else{this.#r({type:"pending",variables:e,isPaused:r}),await this.#s.config.onMutate?.(e,this,s);let t=await this.options.onMutate?.(e,s);t!==this.state.context&&this.#r({type:"pending",context:t,variables:e,isPaused:r})}let n=await this.#i.start();return await this.#s.config.onSuccess?.(n,e,this.state.context,this,s),await this.options.onSuccess?.(n,e,this.state.context,s),await this.#s.config.onSettled?.(n,null,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(n,null,e,this.state.context,s),this.#r({type:"success",data:n}),n}catch(t){try{throw await this.#s.config.onError?.(t,e,this.state.context,this,s),await this.options.onError?.(t,e,this.state.context,s),await this.#s.config.onSettled?.(void 0,t,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(void 0,t,e,this.state.context,s),t}finally{this.#r({type:"error",error:t})}}finally{this.#s.runNext(this)}}#r(e){this.state=(t=>{switch(e.type){case"failed":return{...t,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...t,isPaused:!0};case"continue":return{...t,isPaused:!1};case"pending":return{...t,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:e.isPaused,status:"pending",variables:e.variables,submittedAt:Date.now()};case"success":return{...t,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...t,data:void 0,error:e.error,failureCount:t.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"}}})(this.state),i.Vr.batch(()=>{this.#t.forEach(t=>{t.onMutationUpdate(e)}),this.#s.notify({mutation:this,type:"updated",action:e})})}};function a(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}},5524:function(e,t,s){"use strict";s.d(t,{D:function(){return c}});var i=s(2265),r=s(2812),n=s(9948),o=s(9010),a=s(6298),l=class extends o.l{#e;#n=void 0;#o;#a;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#l()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,a.VS)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#o,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,a.Ym)(t.mutationKey)!==(0,a.Ym)(this.options.mutationKey)?this.reset():this.#o?.state.status==="pending"&&this.#o.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#o?.removeObserver(this)}onMutationUpdate(e){this.#l(),this.#u(e)}getCurrentResult(){return this.#n}reset(){this.#o?.removeObserver(this),this.#o=void 0,this.#l(),this.#u()}mutate(e,t){return this.#a=t,this.#o?.removeObserver(this),this.#o=this.#e.getMutationCache().build(this.#e,this.options),this.#o.addObserver(this),this.#o.execute(e)}#l(){let e=this.#o?.state??(0,r.R)();this.#n={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#u(e){n.Vr.batch(()=>{if(this.#a&&this.hasListeners()){let t=this.#n.variables,s=this.#n.context,i={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};e?.type==="success"?(this.#a.onSuccess?.(e.data,t,s,i),this.#a.onSettled?.(e.data,null,t,s,i)):e?.type==="error"&&(this.#a.onError?.(e.error,t,s,i),this.#a.onSettled?.(void 0,e.error,t,s,i))}this.listeners.forEach(e=>{e(this.#n)})})}},u=s(3191);function c(e,t){let s=(0,u.NL)(t),[r]=i.useState(()=>new l(s,e));i.useEffect(()=>{r.setOptions(e)},[r,e]);let o=i.useSyncExternalStore(i.useCallback(e=>r.subscribe(n.Vr.batchCalls(e)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),c=i.useCallback((e,t)=>{r.mutate(e,t).catch(a.ZT)},[r]);if(o.error&&(0,a.L3)(r.options.throwOnError,[o.error]))throw o.error;return{...o,mutate:c,mutateAsync:o.mutate}}}},function(e){e.O(0,[543,973,971,23,744],function(){return e(e.s=5020)}),_N_E=e.O()}]);