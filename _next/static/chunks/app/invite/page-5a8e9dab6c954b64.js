(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[652],{2092:function(e,t,i){Promise.resolve().then(i.bind(i,5275))},5275:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return m}});var s=i(7437),r=i(683),n=i(1446),a=i(4316),o=i(3191),l=i(5118),u=i(5524),c=i(7138),d=i(6463),h=i(2265);function p(){var e,t,i,p,m,f;let g=(0,d.useSearchParams)(),v=(0,h.useMemo)(()=>{var e;return null!==(e=null==g?void 0:g.get("token"))&&void 0!==e?e:""},[g]),{user:x,loading:y}=(0,r.aC)(),b=(0,d.useRouter)(),w=(0,o.NL)(),_=(0,l.a)({queryKey:["invite",v],enabled:!!v,queryFn:()=>(0,n.O$)(v)}),N=(0,l.a)({queryKey:["invite-group",null===(e=_.data)||void 0===e?void 0:e.group_id],enabled:!!(null===(t=_.data)||void 0===t?void 0:t.group_id),queryFn:async()=>{var e,t;let i=(0,a.N)(),{data:s,error:r}=await i.from("groups").select("id, name, base_currency").eq("id",null!==(t=null===(e=_.data)||void 0===e?void 0:e.group_id)&&void 0!==t?t:"").maybeSingle();if(r)throw r;return s}}),C=(0,u.D)({mutationFn:async()=>{if(!(null==x?void 0:x.id))throw Error("Necesitas iniciar sesi\xf3n para unirte al grupo");if(!v)throw Error("Enlace inv\xe1lido");return(0,n.Ol)({token:v,userId:x.id})},onSuccess:e=>{w.invalidateQueries({queryKey:["groups",null==x?void 0:x.id]}),b.push("/grupos/detalle?id=".concat(e))}});if(!v)return(0,s.jsx)(r.ZP,{children:(0,s.jsxs)("main",{className:"p-6 space-y-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Invitaci\xf3n inv\xe1lida"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Es necesario un par\xe1metro token en el enlace."}),(0,s.jsx)(c.default,{className:"text-sm text-blue-600 hover:underline",href:"/",children:"Volver al inicio"})]})});if(y)return(0,s.jsx)("main",{className:"p-6 text-sm text-gray-500",children:"Comprobando invitaci\xf3n..."});if(!x)return null;if(_.isError)return(0,s.jsx)(r.ZP,{children:(0,s.jsxs)("main",{className:"p-6 space-y-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"No se pudo cargar la invitaci\xf3n"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:null!==(p=_.error.message)&&void 0!==p?p:"Int\xe9ntalo de nuevo m\xe1s tarde."}),(0,s.jsx)(c.default,{className:"text-sm text-blue-600 hover:underline",href:"/",children:"Volver al inicio"})]})});let E=_.data;return E?"pending"!==E.status?(0,s.jsx)(r.ZP,{children:(0,s.jsxs)("main",{className:"p-6 space-y-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Invitaci\xf3n no disponible"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Esta invitaci\xf3n ya no se puede utilizar."}),(0,s.jsx)(c.default,{className:"text-sm text-blue-600 hover:underline",href:"/grupos/detalle?id=".concat(E.group_id),children:"Ir al grupo"})]})}):E.expires_at&&new Date(E.expires_at)<new Date?(0,s.jsx)(r.ZP,{children:(0,s.jsxs)("main",{className:"p-6 space-y-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Invitaci\xf3n expirada"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Solicita una nueva invitaci\xf3n al propietario del grupo."}),(0,s.jsx)(c.default,{className:"text-sm text-blue-600 hover:underline",href:"/",children:"Volver al inicio"})]})}):(0,s.jsx)(r.ZP,{children:(0,s.jsxs)("main",{className:"p-6 space-y-6",children:[(0,s.jsxs)("header",{className:"space-y-2",children:[(0,s.jsxs)("p",{className:"text-sm text-gray-500",children:["Invitaci\xf3n para ",E.email]}),(0,s.jsxs)("h1",{className:"text-2xl font-semibold",children:["Unirte a ",null!==(m=null===(i=N.data)||void 0===i?void 0:i.name)&&void 0!==m?m:"un grupo"]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["El enlace expira ",function(e){if(!e)return"—";try{return new Date(e).toLocaleString()}catch(e){return"—"}}(E.expires_at)]})]}),(0,s.jsx)("button",{className:"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-60",disabled:C.isPending,onClick:()=>C.mutate(),children:C.isPending?"Uniendo...":"Unirme al grupo"}),C.isError&&(0,s.jsx)("p",{className:"text-sm text-red-600",children:null!==(f=C.error.message)&&void 0!==f?f:"No se pudo aceptar la invitaci\xf3n"}),(0,s.jsx)(c.default,{className:"text-sm text-blue-600 hover:underline",href:"/",children:"Volver a inicio"})]})}):(0,s.jsx)(r.ZP,{children:(0,s.jsxs)("main",{className:"p-6 space-y-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Invitaci\xf3n no encontrada"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Es posible que haya caducado o ya haya sido aceptada."}),(0,s.jsx)(c.default,{className:"text-sm text-blue-600 hover:underline",href:"/",children:"Volver al inicio"})]})})}function m(){return(0,s.jsx)(h.Suspense,{fallback:(0,s.jsx)("div",{className:"p-6 text-sm text-gray-500",children:"Cargando invitaci\xf3n..."}),children:(0,s.jsx)(p,{})})}},683:function(e,t,i){"use strict";i.d(t,{Ho:function(){return u},aC:function(){return c}});var s=i(7437),r=i(4316),n=i(6463),a=i(2265);let o=(0,a.createContext)(void 0);async function l(e){var t,i;if(console.log("[ensureProfile] Called with user:",null==e?void 0:e.email),!e)return console.log("[ensureProfile] No user, returning null"),null;let s={id:e.id,email:e.email,display_name:(null===(t=e.user_metadata)||void 0===t?void 0:t.display_name)||(null===(i=e.user_metadata)||void 0===i?void 0:i.full_name)||null};try{let t=(0,r.N)();console.log("[ensureProfile] Fetching profile from DB with 3s timeout...");let i=t.from("profiles").select("id, email, display_name").eq("id",e.id).maybeSingle(),n=new Promise((e,t)=>setTimeout(()=>t(Error("Profile fetch timeout")),3e3)),{data:a,error:o}=await Promise.race([i,n]);if(console.log("[ensureProfile] DB query result:",{existing:a,fetchError:o}),o)return console.error("[Profile] Error fetching profile:",o),console.log("[ensureProfile] Returning fallback after fetch error"),s;if(a)return console.log("[ensureProfile] Profile found:",a),a;console.log("[ensureProfile] No profile found, attempting background create...");let l={id:e.id,email:e.email,display_name:s.display_name};return(0,r.N)().from("profiles").upsert(l).select("id, email, display_name").single().then(e=>{let{data:t,error:i}=e;i?console.error("[Profile] Background upsert error:",i):console.log("[Profile] Background upsert success:",t)}),console.log("[ensureProfile] Returning fallback immediately"),s}catch(e){return console.error("[Profile] Error or timeout:",e),console.log("[ensureProfile] Returning fallback after exception"),s}}function u(e){let{children:t}=e,i=(0,n.useRouter)(),u=(0,n.usePathname)(),[c,d]=(0,a.useState)(null),[h,p]=(0,a.useState)(null),[m,f]=(0,a.useState)(!0),g=(0,a.useRef)(!1),v=(0,a.useMemo)(()=>(0,r.N)(),[]),x=(0,a.useCallback)(async()=>{console.log("[Auth] refresh() called");try{var e,t;let{data:i,error:s}=await v.auth.getSession();if(s){console.error("Error al recuperar la sesi\xf3n",s),d(null),p(null);return}let r=null!==(e=i.session)&&void 0!==e?e:null;d(r);let n=await l(null!==(t=null==r?void 0:r.user)&&void 0!==t?t:null);p(null!=n?n:null)}catch(e){console.error("Error inesperado al recuperar sesi\xf3n:",e),d(null),p(null)}finally{f(!1)}},[v]);(0,a.useEffect)(()=>{if(g.current)return;g.current=!0;let e=!0,t=setTimeout(()=>{e&&(console.warn("[Auth] TIMEOUT: Forcing loading=false after 10 seconds"),f(!1))},1e4);(async()=>{console.log("[Auth] Initializing...");try{var i,s,r,n;let{data:t,error:a}=await v.auth.getSession();if(console.log("[Auth] getSession result:",{hasSession:!!t.session,error:a,userId:null===(s=t.session)||void 0===s?void 0:null===(i=s.user)||void 0===i?void 0:i.id,email:null===(n=t.session)||void 0===n?void 0:null===(r=n.user)||void 0===r?void 0:r.email}),!e)return;if(a&&console.error("[Auth] Error getting session:",a),d(t.session),t.session){console.log("[Auth] User found:",t.session.user.email),console.log("[Auth] Calling ensureProfile...");let e=await l(t.session.user);console.log("[Auth] ensureProfile returned:",e),p(e),console.log("[Auth] Profile loaded and state updated")}}catch(e){console.error("[Auth] Error in initialize:",e)}finally{clearTimeout(t),e&&(console.log("[Auth] Setting loading=false"),f(!1))}})();let{data:i}=v.auth.onAuthStateChange(async(t,i)=>{if(e){console.log("[Auth] Event:",t,"Has session:",!!i);try{if(d(i),null==i?void 0:i.user){console.log("[Auth] Loading profile for:",i.user.email);let e=await l(i.user);p(e),console.log("[Auth] Profile loaded in event handler")}else p(null)}catch(e){console.error("[Auth] Error in event handler:",e)}finally{console.log("[Auth] Event handler setting loading=false"),f(!1)}}});return()=>{e=!1,i.subscription.unsubscribe()}},[v]),(0,a.useEffect)(()=>{!m&&(c||"/login"===u?c&&"/login"===u&&i.replace("/"):i.replace("/login"))},[u,c,m,i]);let y=(0,a.useMemo)(()=>{var e;return{session:c,user:null!==(e=null==c?void 0:c.user)&&void 0!==e?e:null,profile:h,loading:m,refresh:x}},[c,h,m,x]);return(0,s.jsx)(o.Provider,{value:y,children:t})}function c(){let e=(0,a.useContext)(o);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}t.ZP=function(e){let{children:t}=e,{loading:i,user:r}=c(),o=(0,n.useRouter)();return((0,a.useEffect)(()=>{console.log("AuthGate - loading:",i,"user:",!!r),i||r||(console.log("AuthGate - Redirigiendo a login"),o.replace("/login"))},[i,r,o]),i)?(0,s.jsxs)("div",{className:"p-6 text-center space-y-4",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),(0,s.jsx)("div",{className:"text-gray-500",children:"Comprobando sesi\xf3n..."}),(0,s.jsx)("div",{className:"text-xs text-gray-400",children:"Si esto tarda mucho, recarga la p\xe1gina"})]}):r?(0,s.jsx)(s.Fragment,{children:t}):null}},1446:function(e,t,i){"use strict";i.d(t,{O$:function(){return n},Ol:function(){return o},Zn:function(){return r},e$:function(){return a}});var s=i(4316);async function r(e){let{groupId:t,email:i,createdBy:r,expiresInHours:n=48}=e;if(!i.trim())throw Error("Introduce un email para invitar");let a=(0,s.N)(),o=i.trim().toLowerCase(),l=crypto.randomUUID(),u=new Date(Date.now()+36e5*n).toISOString(),{data:c,error:d}=await a.from("group_invites").insert({group_id:t,email:o,token:l,status:"pending",expires_at:u,created_by:r}).select().single();if(d)throw d;return c}async function n(e){if(!e.trim())return null;let t=(0,s.N)(),{data:i,error:r}=await t.from("group_invites").select("id, group_id, email, status, token, expires_at, created_at").eq("token",e).maybeSingle();if(r)throw r;return i}async function a(e){if(!e)return[];let t=(0,s.N)(),i=new Date().toISOString(),{data:r,error:n}=await t.from("group_invites").select("id, group_id, email, status, token, expires_at, created_at").eq("email",e.toLowerCase()).eq("status","pending").gt("expires_at",i).order("created_at",{ascending:!1}).limit(20);if(n)throw n;return(null!=r?r:[]).map(e=>{var t,i;return{id:e.id,groupId:e.group_id,email:e.email,status:e.status,token:e.token,expiresAt:null!==(t=e.expires_at)&&void 0!==t?t:null,createdAt:null!==(i=e.created_at)&&void 0!==i?i:null}})}async function o(e){let{token:t,userId:i}=e,r=(0,s.N)(),a=await n(t);if(!a)throw Error("La invitaci\xf3n no existe o ya fue utilizada");if("pending"!==a.status)throw Error("Esta invitaci\xf3n ya no est\xe1 disponible");if(a.expires_at&&new Date(a.expires_at)<new Date)throw Error("La invitaci\xf3n ha expirado");let{data:o,error:l}=await r.from("group_members").select("id, is_active").eq("group_id",a.group_id).eq("user_id",i).maybeSingle();if(l)throw l;if(o){if(!o.is_active){let{error:e}=await r.from("group_members").update({is_active:!0}).eq("id",o.id);if(e)throw e}}else{let{error:e}=await r.from("group_members").insert({group_id:a.group_id,user_id:i,is_active:!0});if(e)throw e}let{error:u}=await r.from("group_invites").update({status:"accepted"}).eq("id",a.id);if(u)throw u;return a.group_id}},4316:function(e,t,i){"use strict";i.d(t,{N:function(){return n}});var s=i(46);let r=globalThis;function n(){let e="https://hlhcpdymkqhqpsaafthm.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsaGNwZHlta3FocXBzYWFmdGhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NDA0MTgsImV4cCI6MjA3ODExNjQxOH0.H_6vnlgCcT_gxmKK9MSOpI9w-p49VnsTV5WZtNcAmys";if(!e||!t)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY environment variables");return r.__supabaseClient||(r.__supabaseClient=(0,s.eI)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,flowType:"pkce",detectSessionInUrl:!0,storage:window.localStorage,storageKey:"appagar-auth"},global:{headers:{"x-client-info":"appagar-web"}},db:{schema:"public"},realtime:{params:{eventsPerSecond:2}}})),r.__supabaseClient}},2812:function(e,t,i){"use strict";i.d(t,{R:function(){return o},m:function(){return a}});var s=i(9948),r=i(3494),n=i(924),a=class extends r.F{#e;#t;#i;#s;constructor(e){super(),this.#e=e.client,this.mutationId=e.mutationId,this.#i=e.mutationCache,this.#t=[],this.state=e.state||o(),this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options=e,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(e){this.#t.includes(e)||(this.#t.push(e),this.clearGcTimeout(),this.#i.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.#t=this.#t.filter(t=>t!==e),this.scheduleGc(),this.#i.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.#t.length||("pending"===this.state.status?this.scheduleGc():this.#i.remove(this))}continue(){return this.#s?.continue()??this.execute(this.state.variables)}async execute(e){let t=()=>{this.#r({type:"continue"})},i={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#s=(0,n.Mz)({fn:()=>this.options.mutationFn?this.options.mutationFn(e,i):Promise.reject(Error("No mutationFn found")),onFail:(e,t)=>{this.#r({type:"failed",failureCount:e,error:t})},onPause:()=>{this.#r({type:"pause"})},onContinue:t,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#i.canRun(this)});let s="pending"===this.state.status,r=!this.#s.canStart();try{if(s)t();else{this.#r({type:"pending",variables:e,isPaused:r}),await this.#i.config.onMutate?.(e,this,i);let t=await this.options.onMutate?.(e,i);t!==this.state.context&&this.#r({type:"pending",context:t,variables:e,isPaused:r})}let n=await this.#s.start();return await this.#i.config.onSuccess?.(n,e,this.state.context,this,i),await this.options.onSuccess?.(n,e,this.state.context,i),await this.#i.config.onSettled?.(n,null,this.state.variables,this.state.context,this,i),await this.options.onSettled?.(n,null,e,this.state.context,i),this.#r({type:"success",data:n}),n}catch(t){try{throw await this.#i.config.onError?.(t,e,this.state.context,this,i),await this.options.onError?.(t,e,this.state.context,i),await this.#i.config.onSettled?.(void 0,t,this.state.variables,this.state.context,this,i),await this.options.onSettled?.(void 0,t,e,this.state.context,i),t}finally{this.#r({type:"error",error:t})}}finally{this.#i.runNext(this)}}#r(e){this.state=(t=>{switch(e.type){case"failed":return{...t,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...t,isPaused:!0};case"continue":return{...t,isPaused:!1};case"pending":return{...t,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:e.isPaused,status:"pending",variables:e.variables,submittedAt:Date.now()};case"success":return{...t,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...t,data:void 0,error:e.error,failureCount:t.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"}}})(this.state),s.Vr.batch(()=>{this.#t.forEach(t=>{t.onMutationUpdate(e)}),this.#i.notify({mutation:this,type:"updated",action:e})})}};function o(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}},5524:function(e,t,i){"use strict";i.d(t,{D:function(){return c}});var s=i(2265),r=i(2812),n=i(9948),a=i(9010),o=i(6298),l=class extends a.l{#e;#n=void 0;#a;#o;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#l()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,o.VS)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#a,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,o.Ym)(t.mutationKey)!==(0,o.Ym)(this.options.mutationKey)?this.reset():this.#a?.state.status==="pending"&&this.#a.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#a?.removeObserver(this)}onMutationUpdate(e){this.#l(),this.#u(e)}getCurrentResult(){return this.#n}reset(){this.#a?.removeObserver(this),this.#a=void 0,this.#l(),this.#u()}mutate(e,t){return this.#o=t,this.#a?.removeObserver(this),this.#a=this.#e.getMutationCache().build(this.#e,this.options),this.#a.addObserver(this),this.#a.execute(e)}#l(){let e=this.#a?.state??(0,r.R)();this.#n={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#u(e){n.Vr.batch(()=>{if(this.#o&&this.hasListeners()){let t=this.#n.variables,i=this.#n.context,s={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};e?.type==="success"?(this.#o.onSuccess?.(e.data,t,i,s),this.#o.onSettled?.(e.data,null,t,i,s)):e?.type==="error"&&(this.#o.onError?.(e.error,t,i,s),this.#o.onSettled?.(void 0,e.error,t,i,s))}this.listeners.forEach(e=>{e(this.#n)})})}},u=i(3191);function c(e,t){let i=(0,u.NL)(t),[r]=s.useState(()=>new l(i,e));s.useEffect(()=>{r.setOptions(e)},[r,e]);let a=s.useSyncExternalStore(s.useCallback(e=>r.subscribe(n.Vr.batchCalls(e)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),c=s.useCallback((e,t)=>{r.mutate(e,t).catch(o.ZT)},[r]);if(a.error&&(0,o.L3)(r.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}}},function(e){e.O(0,[543,973,586,971,23,744],function(){return e(e.s=2092)}),_N_E=e.O()}]);