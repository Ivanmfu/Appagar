"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[194],{683:function(e,r,l){l.d(r,{Ho:function(){return u},aC:function(){return d}});var t=l(7437),n=l(4316),o=l(6463),i=l(2265);let a=(0,i.createContext)(void 0);async function s(e){var r,l;if(console.log("[ensureProfile] Called with user:",null==e?void 0:e.email),!e)return console.log("[ensureProfile] No user, returning null"),null;let t={id:e.id,email:e.email,display_name:(null===(r=e.user_metadata)||void 0===r?void 0:r.display_name)||(null===(l=e.user_metadata)||void 0===l?void 0:l.full_name)||null};try{let r=(0,n.N)();console.log("[ensureProfile] Fetching profile from DB with 3s timeout...");let l=r.from("profiles").select("id, email, display_name").eq("id",e.id).maybeSingle(),o=new Promise((e,r)=>setTimeout(()=>r(Error("Profile fetch timeout")),3e3)),{data:i,error:a}=await Promise.race([l,o]);if(console.log("[ensureProfile] DB query result:",{existing:i,fetchError:a}),a)return console.error("[Profile] Error fetching profile:",a),console.log("[ensureProfile] Returning fallback after fetch error"),t;if(i)return console.log("[ensureProfile] Profile found:",i),i;console.log("[ensureProfile] No profile found, attempting background create...");let s={id:e.id,email:e.email,display_name:t.display_name};return(0,n.N)().from("profiles").upsert(s).select("id, email, display_name").single().then(e=>{let{data:r,error:l}=e;l?console.error("[Profile] Background upsert error:",l):console.log("[Profile] Background upsert success:",r)}),console.log("[ensureProfile] Returning fallback immediately"),t}catch(e){return console.error("[Profile] Error or timeout:",e),console.log("[ensureProfile] Returning fallback after exception"),t}}function u(e){let{children:r}=e,l=(0,o.useRouter)(),u=(0,o.usePathname)(),[d,c]=(0,i.useState)(null),[m,f]=(0,i.useState)(null),[p,g]=(0,i.useState)(!0),_=(0,i.useRef)(!1),h=(0,i.useMemo)(()=>(0,n.N)(),[]),v=(0,i.useCallback)(async()=>{console.log("[Auth] refresh() called");try{var e,r;let{data:l,error:t}=await h.auth.getSession();if(t){console.error("Error al recuperar la sesi\xf3n",t),c(null),f(null);return}let n=null!==(e=l.session)&&void 0!==e?e:null;c(n);let o=await s(null!==(r=null==n?void 0:n.user)&&void 0!==r?r:null);f(null!=o?o:null)}catch(e){console.error("Error inesperado al recuperar sesi\xf3n:",e),c(null),f(null)}finally{g(!1)}},[h]);(0,i.useEffect)(()=>{if(_.current)return;_.current=!0;let e=!0,r=setTimeout(()=>{e&&(console.warn("[Auth] TIMEOUT: Forcing loading=false after 10 seconds"),g(!1))},1e4);(async()=>{console.log("[Auth] Initializing...");try{var l,t,n,o;let{data:r,error:i}=await h.auth.getSession();if(console.log("[Auth] getSession result:",{hasSession:!!r.session,error:i,userId:null===(t=r.session)||void 0===t?void 0:null===(l=t.user)||void 0===l?void 0:l.id,email:null===(o=r.session)||void 0===o?void 0:null===(n=o.user)||void 0===n?void 0:n.email}),!e)return;if(i&&console.error("[Auth] Error getting session:",i),c(r.session),r.session){console.log("[Auth] User found:",r.session.user.email),console.log("[Auth] Calling ensureProfile...");let e=await s(r.session.user);console.log("[Auth] ensureProfile returned:",e),f(e),console.log("[Auth] Profile loaded and state updated")}}catch(e){console.error("[Auth] Error in initialize:",e)}finally{clearTimeout(r),e&&(console.log("[Auth] Setting loading=false"),g(!1))}})();let{data:l}=h.auth.onAuthStateChange(async(r,l)=>{if(e){console.log("[Auth] Event:",r,"Has session:",!!l);try{if(c(l),null==l?void 0:l.user){console.log("[Auth] Loading profile for:",l.user.email);let e=await s(l.user);f(e),console.log("[Auth] Profile loaded in event handler")}else f(null)}catch(e){console.error("[Auth] Error in event handler:",e)}finally{console.log("[Auth] Event handler setting loading=false"),g(!1)}}});return()=>{e=!1,l.subscription.unsubscribe()}},[h]),(0,i.useEffect)(()=>{!p&&(d||"/login"===u?d&&"/login"===u&&l.replace("/"):l.replace("/login"))},[u,d,p,l]);let y=(0,i.useMemo)(()=>{var e;return{session:d,user:null!==(e=null==d?void 0:d.user)&&void 0!==e?e:null,profile:m,loading:p,refresh:v}},[d,m,p,v]);return(0,t.jsx)(a.Provider,{value:y,children:r})}function d(){let e=(0,i.useContext)(a);if(!e)throw Error("useAuth debe usarse dentro de un AuthProvider");return e}r.ZP=function(e){let{children:r}=e,{loading:l,user:n}=d(),a=(0,o.useRouter)();return((0,i.useEffect)(()=>{console.log("AuthGate - loading:",l,"user:",!!n),l||n||(console.log("AuthGate - Redirigiendo a login"),a.replace("/login"))},[l,n,a]),l)?(0,t.jsxs)("div",{className:"p-6 text-center space-y-4",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),(0,t.jsx)("div",{className:"text-gray-500",children:"Comprobando sesi\xf3n..."}),(0,t.jsx)("div",{className:"text-xs text-gray-400",children:"Si esto tarda mucho, recarga la p\xe1gina"})]}):n?(0,t.jsx)(t.Fragment,{children:r}):null}},6294:function(e,r,l){l.d(r,{sS:function(){return s},JM:function(){return a},a_:function(){return i}});var t=l(4316),n=l(313);async function o(e){let r=(0,t.N)(),{data:l,error:o}=await r.from("group_balance").select("*").eq("group_id",e);if(o)throw o;let i=null!=l?l:[],a=i.map(e=>({userId:e.user_id,net:e.net_minor}));return{balances:i,transactions:(0,n.X)(a)}}async function i(e){let r=(0,t.N)(),{data:l,error:n}=await r.from("group_members").select("group_id").eq("user_id",e).eq("is_active",!0);if(n)throw n;let o=(null!=l?l:[]).map(e=>e.group_id);if(0===o.length)return[];let[{data:i,error:a},{data:s,error:u},{data:d,error:c}]=await Promise.all([r.from("groups").select("id, name, base_currency, created_at").in("id",o),r.from("group_members").select("group_id, user_id").in("group_id",o).eq("is_active",!0),r.from("expenses").select("group_id, date, created_at").in("group_id",o).order("date",{ascending:!1}).limit(5*o.length)]);if(a)throw a;if(u)throw u;if(c)throw c;let m=new Map;(null!=s?s:[]).forEach(e=>{var r;m.set(e.group_id,(null!==(r=m.get(e.group_id))&&void 0!==r?r:0)+1)});let f=new Map;for(let e of c?[]:null!=d?d:[])if(!f.has(e.group_id)){var p,g;f.set(e.group_id,null!==(g=null!==(p=e.date)&&void 0!==p?p:e.created_at)&&void 0!==g?g:null)}return(null!=i?i:[]).map(e=>{var r,l;return{id:e.id,name:e.name,baseCurrency:e.base_currency,createdAt:e.created_at,memberCount:null!==(r=m.get(e.id))&&void 0!==r?r:0,lastExpenseAt:null!==(l=f.get(e.id))&&void 0!==l?l:null}})}async function a(e){var r,l,n,i,a;let s=(0,t.N)(),{data:u,error:d}=await s.from("groups").select("id, name, base_currency, created_at, created_by").eq("id",e).maybeSingle();if(d)throw d;if(!u)throw Error("El grupo no existe o no tienes acceso");let[c,m,f]=await Promise.all([s.from("group_members").select("user_id, joined_at, role, is_active").eq("group_id",e),s.from("group_invites").select("id, email, status, token, expires_at, created_at, created_by").eq("group_id",e).order("created_at",{ascending:!1}).limit(20),s.from("expenses").select("id, group_id, payer_id, amount_minor, amount_base_minor, currency, note, date, category, created_at").eq("group_id",e).order("date",{ascending:!1}).order("created_at",{ascending:!1}).limit(50)]);if(c.error)throw c.error;if(m.error)throw m.error;if(f.error)throw f.error;let p=null!==(r=c.data)&&void 0!==r?r:[],g=null!==(l=f.data)&&void 0!==l?l:[],_=g.map(e=>e.id),h=p.map(e=>e.user_id),v=g.map(e=>e.payer_id),y=_.length?await s.from("expense_participants").select("expense_id, user_id, share_minor").in("expense_id",_):{data:[],error:null};if(y.error)throw y.error;let b=null!==(n=y.data)&&void 0!==n?n:[],w=Array.from(new Set([...h,...v,...b.map(e=>e.user_id)])),A=w.length?await s.from("profiles").select("id, email, display_name").in("id",w):{data:[],error:null};if(A.error)throw A.error;let E=new Map;(null!==(i=A.data)&&void 0!==i?i:[]).forEach(e=>{E.set(e.id,e)});let I=p.filter(e=>e.is_active).map(e=>{var r,l,t,n;let o=null!==(r=E.get(e.user_id))&&void 0!==r?r:null;return{userId:e.user_id,displayName:null!==(l=null==o?void 0:o.display_name)&&void 0!==l?l:null,email:null!==(t=null==o?void 0:o.email)&&void 0!==t?t:null,joinedAt:e.joined_at,role:null!==(n=e.role)&&void 0!==n?n:null,isActive:e.is_active}}),x=b.reduce((e,r)=>{var l,t,n;let o=null!==(l=E.get(r.user_id))&&void 0!==l?l:null,i={userId:r.user_id,shareMinor:r.share_minor,displayName:null!==(t=null==o?void 0:o.display_name)&&void 0!==t?t:null,email:null!==(n=null==o?void 0:o.email)&&void 0!==n?n:null};return e[r.expense_id]=e[r.expense_id]?[...e[r.expense_id],i]:[i],e},{});return{group:u,members:I,expenses:g.map(e=>{var r,l,t,n,o,i,a,s;let u=null!==(r=E.get(e.payer_id))&&void 0!==r?r:null;return{id:e.id,groupId:e.group_id,payerId:e.payer_id,payerName:null!==(t=null!==(l=null==u?void 0:u.display_name)&&void 0!==l?l:null==u?void 0:u.email)&&void 0!==t?t:null,amountMinor:e.amount_minor,amountBaseMinor:e.amount_base_minor,currency:e.currency,date:null!==(n=e.date)&&void 0!==n?n:null,note:null!==(o=e.note)&&void 0!==o?o:null,createdAt:null!==(i=e.created_at)&&void 0!==i?i:null,category:null!==(a=e.category)&&void 0!==a?a:null,participants:null!==(s=x[e.id])&&void 0!==s?s:[]}}),invites:(null!==(a=m.data)&&void 0!==a?a:[]).map(e=>{var r,l;return{id:e.id,email:e.email,status:e.status,token:e.token,expiresAt:null!==(r=e.expires_at)&&void 0!==r?r:null,createdAt:null!==(l=e.created_at)&&void 0!==l?l:null,createdBy:e.created_by}}),balances:await o(e)}}async function s(e){let{name:r,userId:l,baseCurrency:n="EUR",email:o=null,displayName:i=null}=e,a=(0,t.N)();if(!r.trim())throw Error("Introduce un nombre de grupo");let{error:s}=await a.from("profiles").upsert({id:l,email:o,display_name:i,created_at:null},{onConflict:"id"}).select("id").single();if(s)throw s;let{data:u,error:d}=await a.from("groups").insert({name:r.trim(),base_currency:n,created_by:l}).select("id, name, base_currency, created_at, created_by").single();if(d)throw d;let{error:c}=await a.from("group_members").insert({group_id:u.id,user_id:l,is_active:!0,role:"owner"});if(c)throw c;return u}},313:function(e,r,l){function t(e,r){if(!Number.isInteger(e))throw Error("totalCents debe ser un n\xfamero entero");if(!Number.isInteger(r)||r<=0)throw Error("n debe ser un entero positivo");let l=e%r,t=Array(r).fill(Math.floor(e/r));for(let e=0;e<l;e++)t[e]+=1;return t}function n(e){let r=[...e].filter(e=>e.net<0).map(e=>({id:e.userId,amt:-e.net})).sort((e,r)=>r.amt-e.amt),l=[...e].filter(e=>e.net>0).map(e=>({id:e.userId,amt:e.net})).sort((e,r)=>r.amt-e.amt),t=[],n=0,o=0;for(;n<r.length&&o<l.length;){let e=Math.min(r[n].amt,l[o].amt);e>0&&t.push({from:r[n].id,to:l[o].id,amount:e}),r[n].amt-=e,l[o].amt-=e,0===r[n].amt&&n++,0===l[o].amt&&o++}return t}l.d(r,{W:function(){return t},X:function(){return n}})},4316:function(e,r,l){l.d(r,{N:function(){return o}});var t=l(46);let n=globalThis;function o(){let e="https://hlhcpdymkqhqpsaafthm.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsaGNwZHlta3FocXBzYWFmdGhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NDA0MTgsImV4cCI6MjA3ODExNjQxOH0.H_6vnlgCcT_gxmKK9MSOpI9w-p49VnsTV5WZtNcAmys";if(!e||!r)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY environment variables");return n.__supabaseClient||(n.__supabaseClient=(0,t.eI)(e,r,{auth:{persistSession:!0,autoRefreshToken:!0,flowType:"pkce",detectSessionInUrl:!0,storage:window.localStorage,storageKey:"appagar-auth"},global:{headers:{"x-client-info":"appagar-web"}},db:{schema:"public"},realtime:{params:{eventsPerSecond:2}}})),n.__supabaseClient}}}]);